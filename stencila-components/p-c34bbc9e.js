import{c as t,L as i,d as s,i as e,s as r,T as h,N as n,a,l,g as o,b as u,t as f}from"./p-6c5c4643.js";import"./p-ca64077e.js";import"./p-0a0d477e.js";import"./p-5bfddd9d.js";import"./p-7d5dbd9a.js";import"./p-6d2953a4.js";import"./p-54d6a6c0.js";function p(i,s,e,r=0,h=0){return null==s&&-1==(s=i.search(/[^\s\u00a0]/))&&(s=i.length),t(i.slice(r,s),h,e)}class c{constructor(t,i,s){this.string=t,this.tabSize=i,this.indentUnit=s,this.pos=0,this.start=0,this.lastColumnPos=0,this.lastColumnValue=0}eol(){return this.pos>=this.string.length}sol(){return 0==this.pos}peek(){return this.string.charAt(this.pos)||void 0}next(){if(this.pos<this.string.length)return this.string.charAt(this.pos++)}eat(t){let i,s=this.string.charAt(this.pos);if(i="string"==typeof t?s==t:s&&(t instanceof RegExp?t.test(s):t(s)),i)return++this.pos,s}eatWhile(t){let i=this.pos;for(;this.eat(t););return this.pos>i}eatSpace(){let t=this.pos;for(;/[\s\u00a0]/.test(this.string.charAt(this.pos));)++this.pos;return this.pos>t}skipToEnd(){this.pos=this.string.length}skipTo(t){let i=this.string.indexOf(t,this.pos);if(i>-1)return this.pos=i,!0}backUp(t){this.pos-=t}column(){return this.lastColumnPos<this.start&&(this.lastColumnValue=p(this.string,this.start,this.tabSize,this.lastColumnPos,this.lastColumnValue),this.lastColumnPos=this.start),this.lastColumnValue}indentation(){return p(this.string,null,this.tabSize)}match(t,i,s){if("string"==typeof t){let e=t=>s?t.toLowerCase():t;return e(this.string.substr(this.pos,t.length))==e(t)?(!1!==i&&(this.pos+=t.length),!0):null}{let s=this.string.slice(this.pos).match(t);return s&&s.index>0?null:(s&&!1!==i&&(this.pos+=s[0].length),s)}}current(){return this.string.slice(this.start,this.pos)}}function d(t){if("object"!=typeof t)return t;let i={};for(let s in t){let e=t[s];i[s]=e instanceof Array?e.slice():e}return i}class m extends i{constructor(t){let i=s(t.languageData),r={token:(h=t).token,blankLine:h.blankLine||(()=>{}),startState:h.startState||(()=>!0),copyState:h.copyState||d,indent:h.indent||(()=>null),languageData:h.languageData||{}};var h;super(i,{startParse:(t,i,s)=>new w(this,t,i,s)},function(t){let i=n.define({id:v.length,name:"Document",props:[l.add((()=>t))]});return v.push(i),i}(i),[e.of(((t,i)=>this.getIndent(t,i)))]),this.streamParser=r,this.stateAfter=new WeakMap}static define(t){return new m(t)}getIndent(t,i){let s=r(t.state),e=s.resolve(i);for(;e&&e.type!=this.topNode;)e=e.parent;if(!e)return null;let h,n,a=g(this,s,0,e.from,i);if(a?(n=a.state,h=a.pos+1):(n=this.streamParser.startState(t.unit),h=0),i-h>1e4)return null;for(;h<i;){let s=t.state.doc.lineAt(h),e=Math.min(i,s.to);if(s.length){let i=new c(s.text,t.state.tabSize,t.unit);for(;i.pos<e-s.from;)y(this.streamParser.token,i,n)}else this.streamParser.blankLine(n,t.unit);if(e==i)break;h=s.to+1}let{text:l}=t.state.doc.lineAt(i);return this.streamParser.indent(n,/^\s*(.*)/.exec(l)[1],t)}get allowsNesting(){return!1}}function g(t,i,s,e,r){let n=s>=e&&s+i.length<=r&&t.stateAfter.get(i);if(n)return{state:t.streamParser.copyState(n),pos:s+i.length};for(let a=i.children.length-1;a>=0;a--){let n=i.children[a],l=s+i.positions[a],o=n instanceof h&&l<r&&g(t,n,l,e,r);if(o)return o}return null}function b(t,i,s,e,r){if(r&&s<=0&&e>=i.length)return i;r||i.type!=t.topNode||(r=!0);for(let n=i.children.length-1;n>=0;n--){let a,l=i.positions[n]+s,o=i.children[n];if(l<e&&o instanceof h){if(!(a=b(t,o,s-l,e-l,r)))break;return r?new h(i.type,i.children.slice(0,n).concat(a),i.positions.slice(0,n+1),l+a.length):a}}return null}class w{constructor(t,i,s,e){this.lang=t,this.input=i,this.startPos=s,this.context=e,this.chunks=[],this.chunkPos=[],this.chunk=[];let{state:r,tree:n}=function(t,i,s,e){for(let r of i){let i,e=r.from<=s&&r.to>s&&g(t,r.tree,0-r.offset,s,r.to);if(e&&(i=b(t,r.tree,s+r.offset,e.pos+r.offset,!1)))return{state:e.state,tree:i}}return{state:t.streamParser.startState(o(e)),tree:h.empty}}(t,e.fragments,s,e.state);this.state=r,this.pos=this.chunkStart=s+n.length,n.length&&(this.chunks.push(n),this.chunkPos.push(0)),this.pos<e.viewport.from-1e5&&(this.state=this.lang.streamParser.startState(o(e.state)),e.skipUntilInView(this.pos,e.viewport.from),this.pos=e.viewport.from)}advance(){let t=Math.min(this.context.viewport.to,this.input.length,this.chunkStart+2048);for(;this.pos<t;)this.parseLine();return this.chunkStart<this.pos&&this.finishChunk(),t<this.input.length&&this.pos<this.context.viewport.to?null:(this.context.skipUntilInView(this.pos,this.input.length),this.finish())}parseLine(){let t=this.input.lineAfter(this.pos),{streamParser:i}=this.lang,s=new c(t,this.context?this.context.state.tabSize:4,o(this.context.state));if(s.eol())i.blankLine(this.state,s.indentUnit);else for(;!s.eol();){let t=y(i.token,s,this.state);t&&this.chunk.push(x(t),this.pos+s.start,this.pos+s.pos,4)}this.pos+=t.length,this.pos<this.input.length&&this.pos++}finishChunk(){let t=h.build({buffer:this.chunk,start:this.chunkStart,length:this.pos-this.chunkStart,nodeSet:N,topID:0,maxBufferLength:2048});this.lang.stateAfter.set(t,this.lang.streamParser.copyState(this.state)),this.chunks.push(t),this.chunkPos.push(this.chunkStart-this.startPos),this.chunk=[],this.chunkStart=this.pos}finish(){return new h(this.lang.topNode,this.chunks,this.chunkPos,this.pos-this.startPos).balance()}forceFinish(){return this.finish()}}function y(t,i,s){i.start=i.pos;for(let e=0;e<10;e++){let e=t(i,s);if(i.pos>i.start)return e}throw new Error("Stream parser failed to advance stream.")}const k=Object.create(null),v=[n.none],N=new u(v),j=[];function x(t){return t?k[t]||(k[t]=function(t){let i=null;for(let r of t.split(".")){let t=f[r];t?"function"==typeof t?i?i=t(i):S(r,`Modifier ${r} used at start of tag`):i?S(r,`Tag ${r} used as modifier`):i=t:S(r,`Unknown highlighting tag ${r}`)}if(!i)return 0;let s=t.replace(/ /g,"_"),e=n.define({id:v.length,name:s,props:[a({[s]:i})]});return v.push(e),e.id}(t)):0}for(let[L,M]of[["variable","variableName"],["variable-2","variableName.special"],["string-2","string.special"],["def","variableName.definition"],["tag","typeName"],["attribute","propertyName"],["type","typeName"],["builtin","variableName.standard"],["qualifier","modifier"],["error","invalid"],["header","heading"],["property","propertyName"]])k[L]=x(M);function S(t,i){j.indexOf(t)>-1||(j.push(t),console.warn(i))}export{m as StreamLanguage,c as StringStream}