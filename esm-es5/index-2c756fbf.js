var __extends=this&&this.__extends||function(){var t=function(e,n){t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)if(Object.prototype.hasOwnProperty.call(e,n))t[n]=e[n]};return t(e,n)};return function(e,n){if(typeof n!=="function"&&n!==null)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");t(e,n);function r(){this.constructor=e}e.prototype=n===null?Object.create(n):(r.prototype=n.prototype,new r)}}();import{c as countColumn,L as Language,d as defineLanguageFacet,i as indentService,s as syntaxTree,T as Tree,N as NodeType,a as styleTags,l as languageDataProp,g as getIndentUnit,b as NodeSet,t as tags}from"./stencila-action-menu.stencila-editor.stencila-node-list-919e37a5.js";import"./index-e3052a43.js";import"./slotSelectors-8761b1b3.js";import"./schema-d66ff4ac.js";import"./_commonjsHelpers-8a9f3b18.js";import"./function-df6e836e.js";import"./imagePlotlyUtils-86d8b4db.js";function countCol(t,e,n,r,i){if(r===void 0){r=0}if(i===void 0){i=0}if(e==null){e=t.search(/[^\s\u00a0]/);if(e==-1)e=t.length}return countColumn(t.slice(r,e),i,n)}var StringStream=function(){function t(t,e,n){this.string=t;this.tabSize=e;this.indentUnit=n;this.pos=0;this.start=0;this.lastColumnPos=0;this.lastColumnValue=0}t.prototype.eol=function(){return this.pos>=this.string.length};t.prototype.sol=function(){return this.pos==0};t.prototype.peek=function(){return this.string.charAt(this.pos)||undefined};t.prototype.next=function(){if(this.pos<this.string.length)return this.string.charAt(this.pos++)};t.prototype.eat=function(t){var e=this.string.charAt(this.pos);var n;if(typeof t=="string")n=e==t;else n=e&&(t instanceof RegExp?t.test(e):t(e));if(n){++this.pos;return e}};t.prototype.eatWhile=function(t){var e=this.pos;while(this.eat(t)){}return this.pos>e};t.prototype.eatSpace=function(){var t=this.pos;while(/[\s\u00a0]/.test(this.string.charAt(this.pos)))++this.pos;return this.pos>t};t.prototype.skipToEnd=function(){this.pos=this.string.length};t.prototype.skipTo=function(t){var e=this.string.indexOf(t,this.pos);if(e>-1){this.pos=e;return true}};t.prototype.backUp=function(t){this.pos-=t};t.prototype.column=function(){if(this.lastColumnPos<this.start){this.lastColumnValue=countCol(this.string,this.start,this.tabSize,this.lastColumnPos,this.lastColumnValue);this.lastColumnPos=this.start}return this.lastColumnValue};t.prototype.indentation=function(){return countCol(this.string,null,this.tabSize)};t.prototype.match=function(t,e,n){if(typeof t=="string"){var r=function(t){return n?t.toLowerCase():t};var i=this.string.substr(this.pos,t.length);if(r(i)==r(t)){if(e!==false)this.pos+=t.length;return true}else return null}else{var s=this.string.slice(this.pos).match(t);if(s&&s.index>0)return null;if(s&&e!==false)this.pos+=s[0].length;return s}};t.prototype.current=function(){return this.string.slice(this.start,this.pos)};return t}();function fullParser(t){return{token:t.token,blankLine:t.blankLine||function(){},startState:t.startState||function(){return true},copyState:t.copyState||defaultCopyState,indent:t.indent||function(){return null},languageData:t.languageData||{}}}function defaultCopyState(t){if(typeof t!="object")return t;var e={};for(var n in t){var r=t[n];e[n]=r instanceof Array?r.slice():r}return e}var StreamLanguage=function(t){__extends(e,t);function e(e){var n=this;var r=defineLanguageFacet(e.languageData);var i=fullParser(e);var s=function(t,e,r){return new Parse(n,t,e,r)};n=t.call(this,r,{startParse:s},docID(r),[indentService.of((function(t,e){return n.getIndent(t,e)}))])||this;n.streamParser=i;n.stateAfter=new WeakMap;return n}e.define=function(t){return new e(t)};e.prototype.getIndent=function(t,e){var n=syntaxTree(t.state),r=n.resolve(e);while(r&&r.type!=this.topNode)r=r.parent;if(!r)return null;var i=findState(this,n,0,r.from,e),s,a;if(i){a=i.state;s=i.pos+1}else{a=this.streamParser.startState(t.unit);s=0}if(e-s>1e4)return null;while(s<e){var o=t.state.doc.lineAt(s),h=Math.min(e,o.to);if(o.length){var u=new StringStream(o.text,t.state.tabSize,t.unit);while(u.pos<h-o.from)readToken(this.streamParser.token,u,a)}else{this.streamParser.blankLine(a,t.unit)}if(h==e)break;s=o.to+1}var p=t.state.doc.lineAt(e).text;return this.streamParser.indent(a,/^\s*(.*)/.exec(p)[1],t)};Object.defineProperty(e.prototype,"allowsNesting",{get:function(){return false},enumerable:false,configurable:true});return e}(Language);function findState(t,e,n,r,i){var s=n>=r&&n+e.length<=i&&t.stateAfter.get(e);if(s)return{state:t.streamParser.copyState(s),pos:n+e.length};for(var a=e.children.length-1;a>=0;a--){var o=e.children[a],h=n+e.positions[a];var u=o instanceof Tree&&h<i&&findState(t,o,h,r,i);if(u)return u}return null}function cutTree(t,e,n,r,i){if(i&&n<=0&&r>=e.length)return e;if(!i&&e.type==t.topNode)i=true;for(var s=e.children.length-1;s>=0;s--){var a=e.positions[s]+n,o=e.children[s],h=void 0;if(a<r&&o instanceof Tree){if(!(h=cutTree(t,o,n-a,r-a,i)))break;return!i?h:new Tree(e.type,e.children.slice(0,s).concat(h),e.positions.slice(0,s+1),a+h.length)}}return null}function findStartInFragments(t,e,n,r){for(var i=0,s=e;i<s.length;i++){var a=s[i];var o=a.from<=n&&a.to>n&&findState(t,a.tree,0-a.offset,n,a.to),h=void 0;if(o&&(h=cutTree(t,a.tree,n+a.offset,o.pos+a.offset,false)))return{state:o.state,tree:h}}return{state:t.streamParser.startState(getIndentUnit(r)),tree:Tree.empty}}var Parse=function(){function t(t,e,n,r){this.lang=t;this.input=e;this.startPos=n;this.context=r;this.chunks=[];this.chunkPos=[];this.chunk=[];var i=findStartInFragments(t,r.fragments,n,r.state),s=i.state,a=i.tree;this.state=s;this.pos=this.chunkStart=n+a.length;if(a.length){this.chunks.push(a);this.chunkPos.push(0)}if(this.pos<r.viewport.from-1e5){this.state=this.lang.streamParser.startState(getIndentUnit(r.state));r.skipUntilInView(this.pos,r.viewport.from);this.pos=r.viewport.from}}t.prototype.advance=function(){var t=Math.min(this.context.viewport.to,this.input.length,this.chunkStart+2048);while(this.pos<t)this.parseLine();if(this.chunkStart<this.pos)this.finishChunk();if(t<this.input.length&&this.pos<this.context.viewport.to)return null;this.context.skipUntilInView(this.pos,this.input.length);return this.finish()};t.prototype.parseLine=function(){var t=this.input.lineAfter(this.pos),e=this.lang.streamParser;var n=new StringStream(t,this.context?this.context.state.tabSize:4,getIndentUnit(this.context.state));if(n.eol()){e.blankLine(this.state,n.indentUnit)}else{while(!n.eol()){var r=readToken(e.token,n,this.state);if(r)this.chunk.push(tokenID(r),this.pos+n.start,this.pos+n.pos,4)}}this.pos+=t.length;if(this.pos<this.input.length)this.pos++};t.prototype.finishChunk=function(){var t=Tree.build({buffer:this.chunk,start:this.chunkStart,length:this.pos-this.chunkStart,nodeSet:nodeSet,topID:0,maxBufferLength:2048});this.lang.stateAfter.set(t,this.lang.streamParser.copyState(this.state));this.chunks.push(t);this.chunkPos.push(this.chunkStart-this.startPos);this.chunk=[];this.chunkStart=this.pos};t.prototype.finish=function(){return new Tree(this.lang.topNode,this.chunks,this.chunkPos,this.pos-this.startPos).balance()};t.prototype.forceFinish=function(){return this.finish()};return t}();function readToken(t,e,n){e.start=e.pos;for(var r=0;r<10;r++){var i=t(e,n);if(e.pos>e.start)return i}throw new Error("Stream parser failed to advance stream.")}var tokenTable=Object.create(null);var typeArray=[NodeType.none];var nodeSet=new NodeSet(typeArray);var warned=[];function tokenID(t){return!t?0:tokenTable[t]||(tokenTable[t]=createTokenType(t))}for(var _i=0,_a=[["variable","variableName"],["variable-2","variableName.special"],["string-2","string.special"],["def","variableName.definition"],["tag","typeName"],["attribute","propertyName"],["type","typeName"],["builtin","variableName.standard"],["qualifier","modifier"],["error","invalid"],["header","heading"],["property","propertyName"]];_i<_a.length;_i++){var _b=_a[_i],legacyName=_b[0],name=_b[1];tokenTable[legacyName]=tokenID(name)}function warnForPart(t,e){if(warned.indexOf(t)>-1)return;warned.push(t);console.warn(e)}function createTokenType(t){var e;var n=null;for(var r=0,i=t.split(".");r<i.length;r++){var s=i[r];var a=tags[s];if(!a){warnForPart(s,"Unknown highlighting tag "+s)}else if(typeof a=="function"){if(!n)warnForPart(s,"Modifier "+s+" used at start of tag");else n=a(n)}else{if(n)warnForPart(s,"Tag "+s+" used as modifier");else n=a}}if(!n)return 0;var o=t.replace(/ /g,"_"),h=NodeType.define({id:typeArray.length,name:o,props:[styleTags((e={},e[o]=n,e))]});typeArray.push(h);return h.id}function docID(t){var e=NodeType.define({id:typeArray.length,name:"Document",props:[languageDataProp.add((function(){return t}))]});typeArray.push(e);return e}export{StreamLanguage,StringStream};