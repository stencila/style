var __extends=this&&this.__extends||function(){var t=function(e,r){t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)if(Object.prototype.hasOwnProperty.call(e,r))t[r]=e[r]};return t(e,r)};return function(e,r){if(typeof r!=="function"&&r!==null)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");t(e,r);function s(){this.constructor=e}e.prototype=r===null?Object.create(r):(s.prototype=r.prototype,new s)}}();import{D as DefaultBufferLength,b as NodeSet,N as NodeType,T as Tree,v as stringInput,w as TreeBuffer}from"./stencila-action-menu.stencila-editor.stencila-node-list-919e37a5.js";var Stack=function(){function t(t,e,r,s,i,n,o,a,h,f){this.p=t;this.stack=e;this.state=r;this.reducePos=s;this.pos=i;this.score=n;this.buffer=o;this.bufferBase=a;this.curContext=h;this.parent=f}t.prototype.toString=function(){return"["+this.stack.filter((function(t,e){return e%3==0})).concat(this.state)+"]@"+this.pos+(this.score?"!"+this.score:"")};t.start=function(e,r,s){if(s===void 0){s=0}var i=e.parser.context;return new t(e,[],r,s,s,0,[],0,i?new StackContext(i,i.start):null,null)};Object.defineProperty(t.prototype,"context",{get:function(){return this.curContext?this.curContext.context:null},enumerable:false,configurable:true});t.prototype.pushState=function(t,e){this.stack.push(this.state,e,this.bufferBase+this.buffer.length);this.state=t};t.prototype.reduce=function(t){var e=t>>19,r=t&65535;var s=this.p.parser;var i=s.dynamicPrecedence(r);if(i)this.score+=i;if(e==0){if(r<s.minRepeatTerm)this.storeNode(r,this.reducePos,this.reducePos,4,true);this.pushState(s.getGoto(this.state,r,true),this.reducePos);this.reduceContext(r);return}var n=this.stack.length-(e-1)*3-(t&262144?6:0);var o=this.stack[n-2];var a=this.stack[n-1],h=this.bufferBase+this.buffer.length-a;if(r<s.minRepeatTerm||t&131072){var f=s.stateFlag(this.state,1)?this.pos:this.reducePos;this.storeNode(r,o,f,h+4,true)}if(t&262144){this.state=this.stack[n]}else{var u=this.stack[n-3];this.state=s.getGoto(u,r,true)}while(this.stack.length>n)this.stack.pop();this.reduceContext(r)};t.prototype.storeNode=function(t,e,r,s,i){if(s===void 0){s=4}if(i===void 0){i=false}if(t==0){var n=this,o=this.buffer.length;if(o==0&&n.parent){o=n.bufferBase-n.parent.bufferBase;n=n.parent}if(o>0&&n.buffer[o-4]==0&&n.buffer[o-1]>-1){if(e==r)return;if(n.buffer[o-2]>=e){n.buffer[o-2]=r;return}}}if(!i||this.pos==r){this.buffer.push(t,e,r,s)}else{var a=this.buffer.length;if(a>0&&this.buffer[a-4]!=0)while(a>0&&this.buffer[a-2]>r){this.buffer[a]=this.buffer[a-4];this.buffer[a+1]=this.buffer[a-3];this.buffer[a+2]=this.buffer[a-2];this.buffer[a+3]=this.buffer[a-1];a-=4;if(s>4)s-=4}this.buffer[a]=t;this.buffer[a+1]=e;this.buffer[a+2]=r;this.buffer[a+3]=s}};t.prototype.shift=function(t,e,r){if(t&131072){this.pushState(t&65535,this.pos)}else if((t&262144)==0){var s=this.pos,i=t,n=this.p.parser;if(r>this.pos||e<=n.maxNode){this.pos=r;if(!n.stateFlag(i,1))this.reducePos=r}this.pushState(i,s);if(e<=n.maxNode)this.buffer.push(e,s,r,4);this.shiftContext(e)}else{if(e<=this.p.parser.maxNode)this.buffer.push(e,this.pos,r,4);this.pos=r}};t.prototype.apply=function(t,e,r){if(t&65536)this.reduce(t);else this.shift(t,e,r)};t.prototype.useNode=function(t,e){var r=this.p.reused.length-1;if(r<0||this.p.reused[r]!=t){this.p.reused.push(t);r++}var s=this.pos;this.reducePos=this.pos=s+t.length;this.pushState(e,s);this.buffer.push(r,s,this.reducePos,-1);if(this.curContext)this.updateContext(this.curContext.tracker.reuse(this.curContext.context,t,this.p.input,this))};t.prototype.split=function(){var e=this;var r=e.buffer.length;while(r>0&&e.buffer[r-2]>e.reducePos)r-=4;var s=e.buffer.slice(r),i=e.bufferBase+r;while(e&&i==e.bufferBase)e=e.parent;return new t(this.p,this.stack.slice(),this.state,this.reducePos,this.pos,this.score,s,i,this.curContext,e)};t.prototype.recoverByDelete=function(t,e){var r=t<=this.p.parser.maxNode;if(r)this.storeNode(t,this.pos,e);this.storeNode(0,this.pos,e,r?8:4);this.pos=this.reducePos=e;this.score-=200};t.prototype.canShift=function(t){for(var e=new SimulatedStack(this);;){var r=this.p.parser.stateSlot(e.top,4)||this.p.parser.hasAction(e.top,t);if((r&65536)==0)return true;if(r==0)return false;e.reduce(r)}};Object.defineProperty(t.prototype,"ruleStart",{get:function(){for(var t=this.state,e=this.stack.length;;){var r=this.p.parser.stateSlot(t,5);if(!(r&65536))return 0;e-=3*(r>>19);if((r&65535)<this.p.parser.minRepeatTerm)return this.stack[e+1];t=this.stack[e]}},enumerable:false,configurable:true});t.prototype.startOf=function(t,e){var r=this.state,s=this.stack.length,i=this.p.parser;for(;;){var n=i.stateSlot(r,5);var o=n>>19,a=n&65535;if(t.indexOf(a)>-1){var h=s-3*(n>>19),f=this.stack[h+1];if(e==null||e>f)return f}if(s==0)return null;if(o==0){s-=3;r=this.stack[s]}else{s-=3*(o-1);r=i.getGoto(this.stack[s-3],a,true)}}};t.prototype.recoverByInsert=function(t){if(this.stack.length>=300)return[];var e=this.p.parser.nextStates(this.state);if(e.length>4<<1||this.stack.length>=120){var r=[];for(var s=0,i=void 0;s<e.length;s+=2){if((i=e[s+1])!=this.state&&this.p.parser.hasAction(i,t))r.push(e[s],i)}if(this.stack.length<120){var n=function(t){var s=e[t+1];if(!r.some((function(t,e){return e&1&&t==s})))r.push(e[t],s)};for(var s=0;r.length<4<<1&&s<e.length;s+=2){n(s)}}e=r}var o=[];for(var s=0;s<e.length&&o.length<4;s+=2){var i=e[s+1];if(i==this.state)continue;var a=this.split();a.storeNode(0,a.pos,a.pos,4,true);a.pushState(i,this.pos);a.shiftContext(e[s]);a.score-=200;o.push(a)}return o};t.prototype.forceReduce=function(){var t=this.p.parser.stateSlot(this.state,5);if((t&65536)==0)return false;if(!this.p.parser.validAction(this.state,t)){this.storeNode(0,this.reducePos,this.reducePos,4,true);this.score-=100}this.reduce(t);return true};t.prototype.forceAll=function(){while(!this.p.parser.stateFlag(this.state,2)&&this.forceReduce()){}return this};Object.defineProperty(t.prototype,"deadEnd",{get:function(){if(this.stack.length!=3)return false;var t=this.p.parser;return t.data[t.stateSlot(this.state,1)]==65535&&!t.stateSlot(this.state,4)},enumerable:false,configurable:true});t.prototype.restart=function(){this.state=this.stack[0];this.stack.length=0};t.prototype.sameState=function(t){if(this.state!=t.state||this.stack.length!=t.stack.length)return false;for(var e=0;e<this.stack.length;e+=3)if(this.stack[e]!=t.stack[e])return false;return true};Object.defineProperty(t.prototype,"parser",{get:function(){return this.p.parser},enumerable:false,configurable:true});t.prototype.dialectEnabled=function(t){return this.p.parser.dialect.flags[t]};t.prototype.shiftContext=function(t){if(this.curContext)this.updateContext(this.curContext.tracker.shift(this.curContext.context,t,this.p.input,this))};t.prototype.reduceContext=function(t){if(this.curContext)this.updateContext(this.curContext.tracker.reduce(this.curContext.context,t,this.p.input,this))};t.prototype.emitContext=function(){var t=this.curContext;if(!t.tracker.strict)return;var e=this.buffer.length-1;if(e<0||this.buffer[e]!=-2)this.buffer.push(t.hash,this.reducePos,this.reducePos,-2)};t.prototype.updateContext=function(t){if(t!=this.curContext.context){var e=new StackContext(this.curContext.tracker,t);if(e.hash!=this.curContext.hash)this.emitContext();this.curContext=e}};return t}();var StackContext=function(){function t(t,e){this.tracker=t;this.context=e;this.hash=t.hash(e)}return t}();var Recover;(function(t){t[t["Token"]=200]="Token";t[t["Reduce"]=100]="Reduce";t[t["MaxNext"]=4]="MaxNext";t[t["MaxInsertStackDepth"]=300]="MaxInsertStackDepth";t[t["DampenInsertStackDepth"]=120]="DampenInsertStackDepth"})(Recover||(Recover={}));var SimulatedStack=function(){function t(t){this.stack=t;this.top=t.state;this.rest=t.stack;this.offset=this.rest.length}t.prototype.reduce=function(t){var e=t&65535,r=t>>19;if(r==0){if(this.rest==this.stack.stack)this.rest=this.rest.slice();this.rest.push(this.top,0,0);this.offset+=3}else{this.offset-=(r-1)*3}var s=this.stack.p.parser.getGoto(this.rest[this.offset-3],e,true);this.top=s};return t}();var StackBufferCursor=function(){function t(t,e,r){this.stack=t;this.pos=e;this.index=r;this.buffer=t.buffer;if(this.index==0)this.maybeNext()}t.create=function(e){return new t(e,e.bufferBase+e.buffer.length,e.buffer.length)};t.prototype.maybeNext=function(){var t=this.stack.parent;if(t!=null){this.index=this.stack.bufferBase-t.bufferBase;this.stack=t;this.buffer=t.buffer}};Object.defineProperty(t.prototype,"id",{get:function(){return this.buffer[this.index-4]},enumerable:false,configurable:true});Object.defineProperty(t.prototype,"start",{get:function(){return this.buffer[this.index-3]},enumerable:false,configurable:true});Object.defineProperty(t.prototype,"end",{get:function(){return this.buffer[this.index-2]},enumerable:false,configurable:true});Object.defineProperty(t.prototype,"size",{get:function(){return this.buffer[this.index-1]},enumerable:false,configurable:true});t.prototype.next=function(){this.index-=4;this.pos-=4;if(this.index==0)this.maybeNext()};t.prototype.fork=function(){return new t(this.stack,this.pos,this.index)};return t}();var Token=function(){function t(){this.start=-1;this.value=-1;this.end=-1}t.prototype.accept=function(t,e){this.value=t;this.end=e};return t}();var TokenGroup=function(){function t(t,e){this.data=t;this.id=e}t.prototype.token=function(t,e,r){readToken(this.data,t,e,r,this.id)};return t}();TokenGroup.prototype.contextual=TokenGroup.prototype.fallback=TokenGroup.prototype.extend=false;var ExternalTokenizer=function(){function t(t,e){if(e===void 0){e={}}this.token=t;this.contextual=!!e.contextual;this.fallback=!!e.fallback;this.extend=!!e.extend}return t}();function readToken(t,e,r,s,i){var n=0,o=1<<i,a=s.p.parser.dialect;t:for(var h=r.start;;){if((o&t[n])==0)break;var f=t[n+1];for(var u=n+3;u<f;u+=2)if((t[u+1]&o)>0){var c=t[u];if(a.allows(c)&&(r.value==-1||r.value==c||s.p.parser.overrides(c,r.value))){r.accept(c,h);break}}var p=e.get(h++);for(var l=0,d=t[n+2];l<d;){var v=l+d>>1;var g=f+v+(v<<1);var k=t[g],y=t[g+1];if(p<k)d=v;else if(p>=y)l=v+1;else{n=t[g+2];continue t}}break}}function decodeArray(t,e){if(e===void 0){e=Uint16Array}if(typeof t!="string")return t;var r=null;for(var s=0,i=0;s<t.length;){var n=0;for(;;){var o=t.charCodeAt(s++),a=false;if(o==126){n=65535;break}if(o>=92)o--;if(o>=34)o--;var h=o-32;if(h>=46){h-=46;a=true}n+=h;if(a)break;n*=46}if(r)r[i++]=n;else r=new e(n)}return r}var verbose=typeof process!="undefined"&&/\bparse\b/.test(process.env.LOG);var stackIDs=null;function cutAt(t,e,r){var s=t.cursor(e);for(;;){if(!(r<0?s.childBefore(e):s.childAfter(e)))for(;;){if((r<0?s.to<=e:s.from>=e)&&!s.type.isError)return r<0?Math.max(0,Math.min(s.to-1,e-5)):Math.min(t.length,Math.max(s.from+1,e+5));if(r<0?s.prevSibling():s.nextSibling())break;if(!s.parent())return r<0?0:t.length}}}var FragmentCursor=function(){function t(t){this.fragments=t;this.i=0;this.fragment=null;this.safeFrom=-1;this.safeTo=-1;this.trees=[];this.start=[];this.index=[];this.nextFragment()}t.prototype.nextFragment=function(){var t=this.fragment=this.i==this.fragments.length?null:this.fragments[this.i++];if(t){this.safeFrom=t.openStart?cutAt(t.tree,t.from+t.offset,1)-t.offset:t.from;this.safeTo=t.openEnd?cutAt(t.tree,t.to+t.offset,-1)-t.offset:t.to;while(this.trees.length){this.trees.pop();this.start.pop();this.index.pop()}this.trees.push(t.tree);this.start.push(-t.offset);this.index.push(0);this.nextStart=this.safeFrom}else{this.nextStart=1e9}};t.prototype.nodeAt=function(t){if(t<this.nextStart)return null;while(this.fragment&&this.safeTo<=t)this.nextFragment();if(!this.fragment)return null;for(;;){var e=this.trees.length-1;if(e<0){this.nextFragment();return null}var r=this.trees[e],s=this.index[e];if(s==r.children.length){this.trees.pop();this.start.pop();this.index.pop();continue}var i=r.children[s];var n=this.start[e]+r.positions[s];if(n>t){this.nextStart=n;return null}else if(n==t&&n+i.length<=this.safeTo){return n==t&&n>=this.safeFrom?i:null}if(i instanceof TreeBuffer){this.index[e]++;this.nextStart=n+i.length}else{this.index[e]++;if(n+i.length>=t){this.trees.push(i);this.start.push(n);this.index.push(0)}}}};return t}();var CachedToken=function(t){__extends(e,t);function e(){var e=t.apply(this,arguments)||this;e.extended=-1;e.mask=0;e.context=0;return e}e.prototype.clear=function(t){this.start=t;this.value=this.extended=-1};return e}(Token);var dummyToken=new Token;var TokenCache=function(){function t(t){this.tokens=[];this.mainToken=dummyToken;this.actions=[];this.tokens=t.tokenizers.map((function(t){return new CachedToken}))}t.prototype.getActions=function(t,e){var r=0;var s=null;var i=t.p.parser,n=i.tokenizers;var o=i.stateSlot(t.state,3);var a=t.curContext?t.curContext.hash:0;for(var h=0;h<n.length;h++){if((1<<h&o)==0)continue;var f=n[h],u=this.tokens[h];if(s&&!f.fallback)continue;if(f.contextual||u.start!=t.pos||u.mask!=o||u.context!=a){this.updateCachedToken(u,f,t,e);u.mask=o;u.context=a}if(u.value!=0){var c=r;if(u.extended>-1)r=this.addActions(t,u.extended,u.end,r);r=this.addActions(t,u.value,u.end,r);if(!f.extend){s=u;if(r>c)break}}}while(this.actions.length>r)this.actions.pop();if(!s){s=dummyToken;s.start=t.pos;if(t.pos==e.length)s.accept(t.p.parser.eofTerm,t.pos);else s.accept(0,t.pos+1)}this.mainToken=s;return this.actions};t.prototype.updateCachedToken=function(t,e,r,s){t.clear(r.pos);e.token(s,t,r);if(t.value>-1){var i=r.p.parser;for(var n=0;n<i.specialized.length;n++)if(i.specialized[n]==t.value){var o=i.specializers[n](s.read(t.start,t.end),r);if(o>=0&&r.p.parser.dialect.allows(o>>1)){if((o&1)==0)t.value=o>>1;else t.extended=o>>1;break}}}else if(r.pos==s.length){t.accept(r.p.parser.eofTerm,r.pos)}else{t.accept(0,r.pos+1)}};t.prototype.putAction=function(t,e,r,s){for(var i=0;i<s;i+=3)if(this.actions[i]==t)return s;this.actions[s++]=t;this.actions[s++]=e;this.actions[s++]=r;return s};t.prototype.addActions=function(t,e,r,s){var i=t.state,n=t.p.parser,o=n.data;for(var a=0;a<2;a++){for(var h=n.stateSlot(i,a?2:1);;h+=3){if(o[h]==65535){if(o[h+1]==1){h=pair(o,h+2)}else{if(s==0&&o[h+1]==2)s=this.putAction(pair(o,h+1),e,r,s);break}}if(o[h]==e)s=this.putAction(pair(o,h+1),e,r,s)}}return s};return t}();var Rec;(function(t){t[t["Distance"]=5]="Distance";t[t["MaxRemainingPerStep"]=3]="MaxRemainingPerStep";t[t["MinBufferLengthPrune"]=200]="MinBufferLengthPrune";t[t["ForceReduceLimit"]=10]="ForceReduceLimit"})(Rec||(Rec={}));var Parse=function(){function t(t,e,r,s){this.parser=t;this.input=e;this.startPos=r;this.context=s;this.pos=0;this.recovering=0;this.nextStackID=9812;this.nested=null;this.nestEnd=0;this.nestWrap=null;this.reused=[];this.tokens=new TokenCache(t);this.topTerm=t.top[1];this.stacks=[Stack.start(this,t.top[0],this.startPos)];var i=s===null||s===void 0?void 0:s.fragments;this.fragments=i&&i.length?new FragmentCursor(i):null}t.prototype.advance=function(){if(this.nested){var t=this.nested.advance();this.pos=this.nested.pos;if(t){this.finishNested(this.stacks[0],t);this.nested=null}return null}var e=this.stacks,r=this.pos;var s=this.stacks=[];var i,n;var o;for(var a=0;a<e.length;a++){var h=e[a],f=void 0;for(;;){if(h.pos>r){s.push(h)}else if(f=this.checkNest(h)){if(!o||o.stack.score<h.score)o=f}else if(this.advanceStack(h,s,e)){continue}else{if(!i){i=[];n=[]}i.push(h);var u=this.tokens.mainToken;n.push(u.value,u.end)}break}}if(o){this.startNested(o);return null}if(!s.length){var c=i&&findFinished(i);if(c)return this.stackToTree(c);if(this.parser.strict){if(verbose&&i)console.log("Stuck with token "+this.parser.getName(this.tokens.mainToken.value));throw new SyntaxError("No parse at "+r)}if(!this.recovering)this.recovering=5}if(this.recovering&&i){var c=this.runRecovery(i,n,s);if(c)return this.stackToTree(c.forceAll())}if(this.recovering){var p=this.recovering==1?1:this.recovering*3;if(s.length>p){s.sort((function(t,e){return e.score-t.score}));while(s.length>p)s.pop()}if(s.some((function(t){return t.reducePos>r})))this.recovering--}else if(s.length>1){t:for(var a=0;a<s.length-1;a++){var h=s[a];for(var l=a+1;l<s.length;l++){var d=s[l];if(h.sameState(d)||h.buffer.length>200&&d.buffer.length>200){if((h.score-d.score||h.buffer.length-d.buffer.length)>0){s.splice(l--,1)}else{s.splice(a--,1);continue t}}}}}this.pos=s[0].pos;for(var a=1;a<s.length;a++)if(s[a].pos<this.pos)this.pos=s[a].pos;return null};t.prototype.advanceStack=function(t,e,r){var s=t.pos,i=this,n=i.input,o=i.parser;var a=verbose?this.stackID(t)+" -> ":"";if(this.fragments){var h=t.curContext&&t.curContext.tracker.strict,f=h?t.curContext.hash:0;for(var u=this.fragments.nodeAt(s);u;){var c=this.parser.nodeSet.types[u.type.id]==u.type?o.getGoto(t.state,u.type.id):-1;if(c>-1&&u.length&&(!h||(u.contextHash||0)==f)){t.useNode(u,c);if(verbose)console.log(a+this.stackID(t)+(" (via reuse of "+o.getName(u.type.id)+")"));return true}if(!(u instanceof Tree)||u.children.length==0||u.positions[0]>0)break;var p=u.children[0];if(p instanceof Tree)u=p;else break}}var l=o.stateSlot(t.state,4);if(l>0){t.reduce(l);if(verbose)console.log(a+this.stackID(t)+(" (via always-reduce "+o.getName(l&65535)+")"));return true}var d=this.tokens.getActions(t,n);for(var v=0;v<d.length;){var g=d[v++],k=d[v++],y=d[v++];var m=v==d.length||!r;var b=m?t:t.split();b.apply(g,k,y);if(verbose)console.log(a+this.stackID(b)+(" (via "+((g&65536)==0?"shift":"reduce of "+o.getName(g&65535))+" for "+o.getName(k)+" @ "+s+(b==t?"":", split")+")"));if(m)return true;else if(b.pos>s)e.push(b);else r.push(b)}return false};t.prototype.advanceFully=function(t,e){var r=t.pos;for(;;){var s=this.checkNest(t);if(s)return s;if(!this.advanceStack(t,null,null))return false;if(t.pos>r){pushStackDedup(t,e);return true}}};t.prototype.runRecovery=function(t,e,r){var s=null,i=false;var n;for(var o=0;o<t.length;o++){var a=t[o],h=e[o<<1],f=e[(o<<1)+1];var u=verbose?this.stackID(a)+" -> ":"";if(a.deadEnd){if(i)continue;i=true;a.restart();if(verbose)console.log(u+this.stackID(a)+" (restarted)");var c=this.advanceFully(a,r);if(c){if(c!==true)n=c;continue}}var p=a.split(),l=u;for(var d=0;p.forceReduce()&&d<10;d++){if(verbose)console.log(l+this.stackID(p)+" (via force-reduce)");var c=this.advanceFully(p,r);if(c){if(c!==true)n=c;break}if(verbose)l=this.stackID(p)+" -> "}for(var v=0,g=a.recoverByInsert(h);v<g.length;v++){var k=g[v];if(verbose)console.log(u+this.stackID(k)+" (via recover-insert)");this.advanceFully(k,r)}if(this.input.length>a.pos){if(f==a.pos){f++;h=0}a.recoverByDelete(h,f);if(verbose)console.log(u+this.stackID(a)+(" (via recover-delete "+this.parser.getName(h)+")"));pushStackDedup(a,r)}else if(!s||s.score<a.score){s=a}}if(s)return s;if(n)for(var y=0,m=this.stacks;y<m.length;y++){var b=m[y];if(b.score>n.stack.score){n=undefined;break}}if(n)this.startNested(n);return null};t.prototype.forceFinish=function(){var t=this.stacks[0].split();if(this.nested)this.finishNested(t,this.nested.forceFinish());return this.stackToTree(t.forceAll())};t.prototype.stackToTree=function(t,e){if(e===void 0){e=t.pos}if(this.parser.context)t.emitContext();return Tree.build({buffer:StackBufferCursor.create(t),nodeSet:this.parser.nodeSet,topID:this.topTerm,maxBufferLength:this.parser.bufferLength,reused:this.reused,start:this.startPos,length:e-this.startPos,minRepeatType:this.parser.minRepeatTerm})};t.prototype.checkNest=function(t){var e=this.parser.findNested(t.state);if(!e)return null;var r=e.value;if(typeof r=="function")r=r(this.input,t);return r?{stack:t,info:e,spec:r}:null};t.prototype.startNested=function(t){var e=t.stack,r=t.info,s=t.spec;this.stacks=[e];this.nestEnd=this.scanForNestEnd(e,r.end,s.filterEnd);this.nestWrap=typeof s.wrapType=="number"?this.parser.nodeSet.types[s.wrapType]:s.wrapType||null;if(s.startParse){this.nested=s.startParse(this.input.clip(this.nestEnd),e.pos,this.context)}else{this.finishNested(e)}};t.prototype.scanForNestEnd=function(t,e,r){for(var s=t.pos;s<this.input.length;s++){dummyToken.start=s;dummyToken.value=-1;e.token(this.input,dummyToken,t);if(dummyToken.value>-1&&(!r||r(this.input.read(s,dummyToken.end))))return s}return this.input.length};t.prototype.finishNested=function(t,e){if(this.nestWrap)e=new Tree(this.nestWrap,e?[e]:[],e?[0]:[],this.nestEnd-t.pos);else if(!e)e=new Tree(NodeType.none,[],[],this.nestEnd-t.pos);var r=this.parser.findNested(t.state);t.useNode(e,this.parser.getGoto(t.state,r.placeholder,true));if(verbose)console.log(this.stackID(t)+" (via unnest)")};t.prototype.stackID=function(t){var e=(stackIDs||(stackIDs=new WeakMap)).get(t);if(!e)stackIDs.set(t,e=String.fromCodePoint(this.nextStackID++));return e+t};return t}();function pushStackDedup(t,e){for(var r=0;r<e.length;r++){var s=e[r];if(s.pos==t.pos&&s.sameState(t)){if(e[r].score<t.score)e[r]=t;return}}e.push(t)}var Dialect=function(){function t(t,e,r){this.source=t;this.flags=e;this.disabled=r}t.prototype.allows=function(t){return!this.disabled||this.disabled[t]==0};return t}();var id=function(t){return t};var ContextTracker=function(){function t(t){this.start=t.start;this.shift=t.shift||id;this.reduce=t.reduce||id;this.reuse=t.reuse||id;this.hash=t.hash;this.strict=t.strict!==false}return t}();var Parser=function(){function t(t){var e=this;this.bufferLength=DefaultBufferLength;this.strict=false;this.cachedDialect=null;if(t.version!=13)throw new RangeError("Parser version ("+t.version+") doesn't match runtime version ("+13+")");var r=decodeArray(t.tokenData);var s=t.nodeNames.split(" ");this.minRepeatTerm=s.length;this.context=t.context;for(var i=0;i<t.repeatNodeCount;i++)s.push("");var n=[];for(var i=0;i<s.length;i++)n.push([]);function o(t,e,r){n[t].push([e,e.deserialize(String(r))])}if(t.nodeProps)for(var a=0,h=t.nodeProps;a<h.length;a++){var f=h[a];var u=f[0];for(var i=1;i<f.length;){var c=f[i++];if(c>=0){o(c,u,f[i++])}else{var p=f[i+-c];for(var l=-c;l>0;l--)o(f[i++],u,p);i++}}}this.specialized=new Uint16Array(t.specialized?t.specialized.length:0);this.specializers=[];if(t.specialized)for(var i=0;i<t.specialized.length;i++){this.specialized[i]=t.specialized[i].term;this.specializers[i]=t.specialized[i].get}this.states=decodeArray(t.states,Uint32Array);this.data=decodeArray(t.stateData);this.goto=decodeArray(t.goto);var d=Object.keys(t.topRules).map((function(e){return t.topRules[e][1]}));this.nodeSet=new NodeSet(s.map((function(r,s){return NodeType.define({name:s>=e.minRepeatTerm?undefined:r,id:s,props:n[s],top:d.indexOf(s)>-1,error:s==0,skipped:t.skippedNodes&&t.skippedNodes.indexOf(s)>-1})})));this.maxTerm=t.maxTerm;this.tokenizers=t.tokenizers.map((function(t){return typeof t=="number"?new TokenGroup(r,t):t}));this.topRules=t.topRules;this.nested=(t.nested||[]).map((function(t){var e=t[0],r=t[1],s=t[2],i=t[3];return{name:e,value:r,end:new TokenGroup(decodeArray(s),0),placeholder:i}}));this.dialects=t.dialects||{};this.dynamicPrecedences=t.dynamicPrecedences||null;this.tokenPrecTable=t.tokenPrec;this.termNames=t.termNames||null;this.maxNode=this.nodeSet.types.length-1;this.dialect=this.parseDialect();this.top=this.topRules[Object.keys(this.topRules)[0]]}t.prototype.parse=function(t,e,r){if(e===void 0){e=0}if(r===void 0){r={}}if(typeof t=="string")t=stringInput(t);var s=new Parse(this,t,e,r);for(;;){var i=s.advance();if(i)return i}};t.prototype.startParse=function(t,e,r){if(e===void 0){e=0}if(r===void 0){r={}}if(typeof t=="string")t=stringInput(t);return new Parse(this,t,e,r)};t.prototype.getGoto=function(t,e,r){if(r===void 0){r=false}var s=this.goto;if(e>=s[0])return-1;for(var i=s[e+1];;){var n=s[i++],o=n&1;var a=s[i++];if(o&&r)return a;for(var h=i+(n>>1);i<h;i++)if(s[i]==t)return a;if(o)return-1}};t.prototype.hasAction=function(t,e){var r=this.data;for(var s=0;s<2;s++){for(var i=this.stateSlot(t,s?2:1),n=void 0;;i+=3){if((n=r[i])==65535){if(r[i+1]==1)n=r[i=pair(r,i+2)];else if(r[i+1]==2)return pair(r,i+2);else break}if(n==e||n==0)return pair(r,i+1)}}return 0};t.prototype.stateSlot=function(t,e){return this.states[t*6+e]};t.prototype.stateFlag=function(t,e){return(this.stateSlot(t,0)&e)>0};t.prototype.findNested=function(t){var e=this.stateSlot(t,0);return e&4?this.nested[e>>10]:null};t.prototype.validAction=function(t,e){if(e==this.stateSlot(t,4))return true;for(var r=this.stateSlot(t,1);;r+=3){if(this.data[r]==65535){if(this.data[r+1]==1)r=pair(this.data,r+2);else return false}if(e==pair(this.data,r+1))return true}};t.prototype.nextStates=function(t){var e=[];var r=function(t){if(s.data[t]==65535){if(s.data[t+1]==1)t=pair(s.data,t+2);else return i=t,"break"}if((s.data[t+2]&65536>>16)==0){var r=s.data[t+1];if(!e.some((function(t,e){return e&1&&t==r})))e.push(s.data[t],r)}i=t};var s=this,i;for(var n=this.stateSlot(t,1);;n+=3){var o=r(n);n=i;if(o==="break")break}return e};t.prototype.overrides=function(t,e){var r=findOffset(this.data,this.tokenPrecTable,e);return r<0||findOffset(this.data,this.tokenPrecTable,t)<r};t.prototype.configure=function(e){var r;var s=Object.assign(Object.create(t.prototype),this);if(e.props)s.nodeSet=(r=this.nodeSet).extend.apply(r,e.props);if(e.top){var i=this.topRules[e.top];if(!i)throw new RangeError("Invalid top rule name "+e.top);s.top=i}if(e.tokenizers)s.tokenizers=this.tokenizers.map((function(t){var r=e.tokenizers.find((function(e){return e.from==t}));return r?r.to:t}));if(e.dialect)s.dialect=this.parseDialect(e.dialect);if(e.nested)s.nested=this.nested.map((function(t){if(!Object.prototype.hasOwnProperty.call(e.nested,t.name))return t;return{name:t.name,value:e.nested[t.name],end:t.end,placeholder:t.placeholder}}));if(e.strict!=null)s.strict=e.strict;if(e.bufferLength!=null)s.bufferLength=e.bufferLength;return s};t.prototype.getName=function(t){return this.termNames?this.termNames[t]:String(t<=this.maxNode&&this.nodeSet.types[t].name||t)};Object.defineProperty(t.prototype,"eofTerm",{get:function(){return this.maxNode+1},enumerable:false,configurable:true});Object.defineProperty(t.prototype,"hasNested",{get:function(){return this.nested.length>0},enumerable:false,configurable:true});Object.defineProperty(t.prototype,"topNode",{get:function(){return this.nodeSet.types[this.top[1]]},enumerable:false,configurable:true});t.prototype.dynamicPrecedence=function(t){var e=this.dynamicPrecedences;return e==null?0:e[t]||0};t.prototype.parseDialect=function(t){if(this.cachedDialect&&this.cachedDialect.source==t)return this.cachedDialect;var e=Object.keys(this.dialects),r=e.map((function(){return false}));if(t)for(var s=0,i=t.split(" ");s<i.length;s++){var n=i[s];var o=e.indexOf(n);if(o>=0)r[o]=true}var a=null;for(var h=0;h<e.length;h++)if(!r[h]){for(var f=this.dialects[e[h]],u;(u=this.data[f++])!=65535;)(a||(a=new Uint8Array(this.maxTerm+1)))[u]=1}return this.cachedDialect=new Dialect(t,r,a)};t.deserialize=function(e){return new t(e)};return t}();function pair(t,e){return t[e]|t[e+1]<<16}function findOffset(t,e,r){for(var s=e,i=void 0;(i=t[s])!=65535;s++)if(i==r)return s-e;return-1}function findFinished(t){var e=null;for(var r=0,s=t;r<s.length;r++){var i=s[r];if(i.pos==i.p.input.length&&i.p.parser.stateFlag(i.state,2)&&(!e||e.score<i.score))e=i}return e}export{ContextTracker as C,ExternalTokenizer as E,Parser as P};