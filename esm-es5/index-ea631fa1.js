var __spreadArray=this&&this.__spreadArray||function(e,t){for(var r=0,n=t.length,i=e.length;r<n;r++,i++)e[i]=t[r];return e};var _a;import{N as NodeType,e as NodeProp,b as NodeSet,T as Tree,v as stringInput,L as Language,s as syntaxTree,E as EditorSelection,x as Text,f as LanguageSupport,P as Prec,y as keymap,d as defineLanguageFacet,a as styleTags,t as tags,z as LanguageDescription,A as EditorParseContext,m as foldNodeProp,j as indentNodeProp,l as languageDataProp}from"./stencila-action-menu.stencila-editor.stencila-node-list-919e37a5.js";import{htmlLanguage}from"./index-030925b5.js";import"./index-e3052a43.js";import"./slotSelectors-8761b1b3.js";import"./schema-d66ff4ac.js";import"./_commonjsHelpers-8a9f3b18.js";import"./function-df6e836e.js";import"./imagePlotlyUtils-86d8b4db.js";import"./index.es-07e36bf2.js";import"./index-a3dcf4a4.js";var CompositeBlock=function(){function e(e,t,r,n,i,s,a){this.type=e;this.value=t;this.from=r;this.hash=n;this.end=i;this.children=s;this.positions=a}e.create=function(t,r,n,i,s){var a=i+(i<<8)+t+(r<<4)|0;return new e(t,r,n,a,s,[],[])};e.prototype.toTree=function(e,t){if(t===void 0){t=this.end}var r=this.children.length-1;if(r>=0)t=Math.max(t,this.positions[r]+this.children[r].length+this.from);var n=new Tree(e.types[this.type],this.children,this.positions,t-this.from).balance(2048);stampContext(n.children,this.hash);return n};e.prototype.copy=function(){return new e(this.type,this.value,this.from,this.hash,this.end,this.children.slice(),this.positions.slice())};return e}();var Type;(function(e){e[e["Document"]=1]="Document";e[e["CodeBlock"]=2]="CodeBlock";e[e["FencedCode"]=3]="FencedCode";e[e["Blockquote"]=4]="Blockquote";e[e["HorizontalRule"]=5]="HorizontalRule";e[e["BulletList"]=6]="BulletList";e[e["OrderedList"]=7]="OrderedList";e[e["ListItem"]=8]="ListItem";e[e["ATXHeading1"]=9]="ATXHeading1";e[e["ATXHeading2"]=10]="ATXHeading2";e[e["ATXHeading3"]=11]="ATXHeading3";e[e["ATXHeading4"]=12]="ATXHeading4";e[e["ATXHeading5"]=13]="ATXHeading5";e[e["ATXHeading6"]=14]="ATXHeading6";e[e["SetextHeading1"]=15]="SetextHeading1";e[e["SetextHeading2"]=16]="SetextHeading2";e[e["HTMLBlock"]=17]="HTMLBlock";e[e["LinkReference"]=18]="LinkReference";e[e["Paragraph"]=19]="Paragraph";e[e["CommentBlock"]=20]="CommentBlock";e[e["ProcessingInstructionBlock"]=21]="ProcessingInstructionBlock";e[e["Escape"]=22]="Escape";e[e["Entity"]=23]="Entity";e[e["HardBreak"]=24]="HardBreak";e[e["Emphasis"]=25]="Emphasis";e[e["StrongEmphasis"]=26]="StrongEmphasis";e[e["Link"]=27]="Link";e[e["Image"]=28]="Image";e[e["InlineCode"]=29]="InlineCode";e[e["HTMLTag"]=30]="HTMLTag";e[e["Comment"]=31]="Comment";e[e["ProcessingInstruction"]=32]="ProcessingInstruction";e[e["URL"]=33]="URL";e[e["HeaderMark"]=34]="HeaderMark";e[e["QuoteMark"]=35]="QuoteMark";e[e["ListMark"]=36]="ListMark";e[e["LinkMark"]=37]="LinkMark";e[e["EmphasisMark"]=38]="EmphasisMark";e[e["CodeMark"]=39]="CodeMark";e[e["CodeInfo"]=40]="CodeInfo";e[e["LinkTitle"]=41]="LinkTitle";e[e["LinkLabel"]=42]="LinkLabel"})(Type||(Type={}));var LeafBlock=function(){function e(e,t){this.start=e;this.content=t;this.marks=[];this.parsers=[]}return e}();var Line=function(){function e(){this.text="";this.baseIndent=0;this.basePos=0;this.depth=0;this.markers=[];this.pos=0;this.indent=0;this.next=-1}e.prototype.forward=function(){if(this.basePos>this.pos)this.forwardInner()};e.prototype.forwardInner=function(){var e=this.skipSpace(this.basePos);this.indent=this.countIndent(e,this.pos,this.indent);this.pos=e;this.next=e==this.text.length?-1:this.text.charCodeAt(e)};e.prototype.skipSpace=function(e){return skipSpace(this.text,e)};e.prototype.reset=function(e){this.text=e;this.baseIndent=this.basePos=this.pos=this.indent=0;this.forwardInner();this.depth=1;while(this.markers.length)this.markers.pop()};e.prototype.moveBase=function(e){this.basePos=e;this.baseIndent=this.countIndent(e,this.pos,this.indent)};e.prototype.moveBaseColumn=function(e){this.baseIndent=e;this.basePos=this.findColumn(e)};e.prototype.addMarker=function(e){this.markers.push(e)};e.prototype.countIndent=function(e,t,r){if(t===void 0){t=0}if(r===void 0){r=0}for(var n=t;n<e;n++)r+=this.text.charCodeAt(n)==9?4-r%4:1;return r};e.prototype.findColumn=function(e){var t=0;for(var r=0;t<this.text.length&&r<e;t++)r+=this.text.charCodeAt(t)==9?4-r%4:1;return t};e.prototype.scrub=function(){if(!this.baseIndent)return this.text;var e="";for(var t=0;t<this.basePos;t++)e+=" ";return e+this.text.slice(this.basePos)};return e}();function skipForList(e,t,r){if(r.pos==r.text.length||e!=t.block&&r.indent>=t.stack[r.depth+1].value+r.baseIndent)return true;if(r.indent>=r.baseIndent+4)return false;var n=(e.type==Type.OrderedList?isOrderedList:isBulletList)(r,t,false);return n>0&&(e.type!=Type.BulletList||isHorizontalRule(r,t,false)<0)&&r.text.charCodeAt(r.pos+n-1)==e.value}var DefaultSkipMarkup=(_a={},_a[Type.Blockquote]=function(e,t,r){if(r.next!=62)return false;r.markers.push(elt(Type.QuoteMark,t.lineStart+r.pos,t.lineStart+r.pos+1));r.moveBase(r.pos+1);e.end=t.lineStart+r.text.length;return true},_a[Type.ListItem]=function(e,t,r){if(r.indent<r.baseIndent+e.value&&r.next>-1)return false;r.moveBaseColumn(r.baseIndent+e.value);return true},_a[Type.OrderedList]=skipForList,_a[Type.BulletList]=skipForList,_a[Type.Document]=function(){return true},_a);function space(e){return e==32||e==9||e==10||e==13}function skipSpace(e,t){if(t===void 0){t=0}while(t<e.length&&space(e.charCodeAt(t)))t++;return t}function skipSpaceBack(e,t,r){while(t>r&&space(e.charCodeAt(t-1)))t--;return t}function isFencedCode(e){if(e.next!=96&&e.next!=126)return-1;var t=e.pos+1;while(t<e.text.length&&e.text.charCodeAt(t)==e.next)t++;if(t<e.pos+3)return-1;if(e.next==96)for(var r=t;r<e.text.length;r++)if(e.text.charCodeAt(r)==96)return-1;return t}function isBlockquote(e){return e.next!=62?-1:e.text.charCodeAt(e.pos+1)==32?2:1}function isHorizontalRule(e,t,r){if(e.next!=42&&e.next!=45&&e.next!=95)return-1;var n=1;for(var i=e.pos+1;i<e.text.length;i++){var s=e.text.charCodeAt(i);if(s==e.next)n++;else if(!space(s))return-1}if(r&&e.next==45&&isSetextUnderline(e)>-1&&e.depth==t.stack.length)return-1;return n<3?-1:1}function inList(e,t){return e.block.type==t||e.stack.length>1&&e.stack[e.stack.length-2].type==t}function isBulletList(e,t,r){return(e.next==45||e.next==43||e.next==42)&&(e.pos==e.text.length-1||space(e.text.charCodeAt(e.pos+1)))&&(!r||inList(t,Type.BulletList)||e.skipSpace(e.pos+2)<e.text.length)?1:-1}function isOrderedList(e,t,r){var n=e.pos,i=e.next;for(;;){if(i>=48&&i<=57)n++;else break;if(n==e.text.length)return-1;i=e.text.charCodeAt(n)}if(n==e.pos||n>e.pos+9||i!=46&&i!=41||n<e.text.length-1&&!space(e.text.charCodeAt(n+1))||r&&!inList(t,Type.OrderedList)&&(e.skipSpace(n+1)==e.text.length||n>e.pos+1||e.next!=49))return-1;return n+1-e.pos}function isAtxHeading(e){if(e.next!=35)return-1;var t=e.pos+1;while(t<e.text.length&&e.text.charCodeAt(t)==35)t++;if(t<e.text.length&&e.text.charCodeAt(t)!=32)return-1;var r=t-e.pos;return r>6?-1:r}function isSetextUnderline(e){if(e.next!=45&&e.next!=61||e.indent>=e.baseIndent+4)return-1;var t=e.pos+1;while(t<e.text.length&&e.text.charCodeAt(t)==e.next)t++;var r=t;while(t<e.text.length&&space(e.text.charCodeAt(t)))t++;return t==e.text.length?r:-1}var EmptyLine=/^[ \t]*$/,CommentEnd=/-->/,ProcessingEnd=/\?>/;var HTMLBlockStyle=[[/^<(?:script|pre|style)(?:\s|>|$)/i,/<\/(?:script|pre|style)>/i],[/^\s*<!--/,CommentEnd],[/^\s*<\?/,ProcessingEnd],[/^\s*<![A-Z]/,/>/],[/^\s*<!\[CDATA\[/,/\]\]>/],[/^\s*<\/?(?:address|article|aside|base|basefont|blockquote|body|caption|center|col|colgroup|dd|details|dialog|dir|div|dl|dt|fieldset|figcaption|figure|footer|form|frame|frameset|h1|h2|h3|h4|h5|h6|head|header|hr|html|iframe|legend|li|link|main|menu|menuitem|nav|noframes|ol|optgroup|option|p|param|section|source|summary|table|tbody|td|tfoot|th|thead|title|tr|track|ul)(?:\s|\/?>|$)/i,EmptyLine],[/^\s*(?:<\/[a-z][\w-]*\s*>|<[a-z][\w-]*(\s+[a-z:_][\w-.]*(?:\s*=\s*(?:[^\s"'=<>`]+|'[^']*'|"[^"]*"))?)*\s*>)\s*$/i,EmptyLine]];function isHTMLBlock(e,t,r){if(e.next!=60)return-1;var n=e.text.slice(e.pos);for(var i=0,s=HTMLBlockStyle.length-(r?1:0);i<s;i++)if(HTMLBlockStyle[i][0].test(n))return i;return-1}function getListIndent(e,t){var r=e.countIndent(t,e.pos,e.indent);var n=e.countIndent(e.skipSpace(t),t,r);return n>=r+5?r+1:n}var DefaultBlockParsers={LinkReference:undefined,IndentedCode:function(e,t){var r=t.baseIndent+4;if(t.indent<r)return false;var n=t.findColumn(r);var i=e.lineStart+n,s=e.lineStart+t.text.length;var a=[],o=[];for(;e.nextLine();){if(t.depth<e.stack.length)break;if(t.pos==t.text.length){for(var l=0,f=t.markers;l<f.length;l++){var p=f[l];o.push(p)}}else if(t.indent<r){break}else{if(o.length){for(var u=0,h=o;u<h.length;u++){var p=h[u];a.push(p)}o=[]}for(var c=0,d=t.markers;c<d.length;c++){var p=d[c];a.push(p)}s=e.lineStart+t.text.length}}if(o.length)t.markers=o.concat(t.markers);var m=!a.length&&e.parser.codeParser&&e.parser.codeParser("");if(m)e.startNested(i,m.startParse(e.input.clip(s),i,e.parseContext),(function(t){return new Tree(e.parser.nodeSet.types[Type.CodeBlock],[t],[0],s-i)}));else e.addNode(e.buffer.writeElements(a,-i).finish(Type.CodeBlock,s-i),i);return true},FencedCode:function(e,t){var r=isFencedCode(t);if(r<0)return false;var n=e.lineStart+t.pos,i=t.next,s=r-t.pos;var a=t.skipSpace(r),o=skipSpaceBack(t.text,t.text.length,a);var l=[elt(Type.CodeMark,n,n+s)],f="";if(a<o){l.push(elt(Type.CodeInfo,e.lineStart+a,e.lineStart+o));f=t.text.slice(a,o)}var p=l.length,u=p;var h=e.lineStart+t.text.length+1,c=-1;for(;e.nextLine();){if(t.depth<e.stack.length)break;for(var d=0,m=t.markers;d<m.length;d++){var g=m[d];l.push(g)}var k=t.pos;if(t.indent-t.baseIndent<4)while(k<t.text.length&&t.text.charCodeAt(k)==i)k++;if(k-t.pos>=s&&t.skipSpace(k)==t.text.length){l.push(elt(Type.CodeMark,e.lineStart+t.pos,e.lineStart+k));p++;c=e.lineStart-1;e.nextLine();break}}var v=e.prevLineEnd();if(c<0)c=v;var y=l.length==p&&e.parser.codeParser&&e.parser.codeParser(f);if(y&&h<c){e.startNested(n,y.startParse(e.input.clip(c),h,e.parseContext),(function(e){l.splice(u,0,new TreeElement(e,h));return elt(Type.FencedCode,n,v,l)}))}else{e.addNode(e.buffer.writeElements(l,-n).finish(Type.FencedCode,e.prevLineEnd()-n),n)}return true},Blockquote:function(e,t){var r=isBlockquote(t);if(r<0)return false;e.startContext(Type.Blockquote,t.pos);e.addNode(Type.QuoteMark,e.lineStart+t.pos,e.lineStart+t.pos+1);t.moveBase(t.pos+r);return null},HorizontalRule:function(e,t){if(isHorizontalRule(t,e,false)<0)return false;var r=e.lineStart+t.pos;e.nextLine();e.addNode(Type.HorizontalRule,r);return true},BulletList:function(e,t){var r=isBulletList(t,e,false);if(r<0)return false;if(e.block.type!=Type.BulletList)e.startContext(Type.BulletList,t.basePos,t.next);var n=getListIndent(t,t.pos+1);e.startContext(Type.ListItem,t.basePos,n-t.baseIndent);e.addNode(Type.ListMark,e.lineStart+t.pos,e.lineStart+t.pos+r);t.moveBaseColumn(n);return null},OrderedList:function(e,t){var r=isOrderedList(t,e,false);if(r<0)return false;if(e.block.type!=Type.OrderedList)e.startContext(Type.OrderedList,t.basePos,t.text.charCodeAt(t.pos+r-1));var n=getListIndent(t,t.pos+r);e.startContext(Type.ListItem,t.basePos,n-t.baseIndent);e.addNode(Type.ListMark,e.lineStart+t.pos,e.lineStart+t.pos+r);t.moveBaseColumn(n);return null},ATXHeading:function(e,t){var r=isAtxHeading(t);if(r<0)return false;var n=t.pos,i=e.lineStart+n;var s=skipSpaceBack(t.text,t.text.length,n),a=s;while(a>n&&t.text.charCodeAt(a-1)==t.next)a--;if(a==s||a==n||!space(t.text.charCodeAt(a-1)))a=t.text.length;var o=e.buffer.write(Type.HeaderMark,0,r).writeElements(e.parser.parseInline(t.text.slice(n+r+1,a),i+r+1),-i);if(a<t.text.length)o.write(Type.HeaderMark,a-n,s-n);var l=o.finish(Type.ATXHeading1-1+r,t.text.length-n);e.nextLine();e.addNode(l,i);return true},HTMLBlock:function(e,t){var r=isHTMLBlock(t,e,false);if(r<0)return false;var n=e.lineStart+t.pos,i=HTMLBlockStyle[r][1];var s=[],a=i!=EmptyLine;while(!i.test(t.text)&&e.nextLine()){if(t.depth<e.stack.length){a=false;break}for(var o=0,l=t.markers;o<l.length;o++){var f=l[o];s.push(f)}}if(a)e.nextLine();var p=i==CommentEnd?Type.CommentBlock:i==ProcessingEnd?Type.ProcessingInstructionBlock:Type.HTMLBlock;var u=e.prevLineEnd();if(!s.length&&p==Type.HTMLBlock&&e.parser.htmlParser){e.startNested(n,e.parser.htmlParser.startParse(e.input.clip(u),n,e.parseContext),(function(t){return new Tree(e.parser.nodeSet.types[p],[t],[0],u-n)}))}else{e.addNode(e.buffer.writeElements(s,-n).finish(p,u-n),n)}return true},SetextHeading:undefined};var LinkReferenceParser=function(){function e(e){this.stage=0;this.elts=[];this.pos=0;this.start=e.start;this.advance(e.content)}e.prototype.nextLine=function(e,t,r){if(this.stage==-1)return false;var n=r.content+"\n"+t.scrub();var i=this.advance(n);if(i>-1&&i<n.length)return this.complete(e,r,i);return false};e.prototype.finish=function(e,t){if((this.stage==2||this.stage==3)&&skipSpace(t.content,this.pos)==t.content.length)return this.complete(e,t,t.content.length);return false};e.prototype.complete=function(e,t,r){e.addLeafElement(t,elt(Type.LinkReference,this.start,this.start+r,this.elts));return true};e.prototype.nextStage=function(e){if(e){this.pos=e.to-this.start;this.elts.push(e);this.stage++;return true}if(e===false)this.stage=-1;return false};e.prototype.advance=function(e){for(;;){if(this.stage==-1){return-1}else if(this.stage==0){if(!this.nextStage(parseLinkLabel(e,this.pos,this.start,true)))return-1;if(e.charCodeAt(this.pos)!=58)return this.stage=-1;this.elts.push(elt(Type.LinkMark,this.pos+this.start,this.pos+this.start+1));this.pos++}else if(this.stage==1){if(!this.nextStage(parseURL(e,skipSpace(e,this.pos),this.start)))return-1}else if(this.stage==2){var t=skipSpace(e,this.pos),r=0;if(t>this.pos){var n=parseLinkTitle(e,t,this.start);if(n){var i=lineEnd(e,n.to-this.start);if(i>0){this.nextStage(n);r=i}}}if(!r)r=lineEnd(e,this.pos);return r>0&&r<e.length?r:-1}else{return lineEnd(e,this.pos)}}};return e}();function lineEnd(e,t){for(;t<e.length;t++){var r=e.charCodeAt(t);if(r==10)break;if(!space(r))return-1}return t}var SetextHeadingParser=function(){function e(){}e.prototype.nextLine=function(e,t,r){var n=t.depth<e.stack.length?-1:isSetextUnderline(t);var i=t.next;if(n<0)return false;var s=elt(Type.HeaderMark,e.lineStart+t.pos,e.lineStart+n);e.nextLine();e.addLeafElement(r,elt(i==61?Type.SetextHeading1:Type.SetextHeading2,r.start,e.prevLineEnd(),__spreadArray(__spreadArray([],e.parser.parseInline(r.content,r.start)),[s])));return true};e.prototype.finish=function(){return false};return e}();var DefaultLeafBlocks={LinkReference:function(e,t){return t.content.charCodeAt(0)==91?new LinkReferenceParser(t):null},SetextHeading:function(){return new SetextHeadingParser}};var DefaultEndLeaf=[function(e,t){return isAtxHeading(t)>=0},function(e,t){return isFencedCode(t)>=0},function(e,t){return isBlockquote(t)>=0},function(e,t){return isBulletList(t,e,true)>=0},function(e,t){return isOrderedList(t,e,true)>=0},function(e,t){return isHorizontalRule(t,e,true)>=0},function(e,t){return isHTMLBlock(t,e,true)>=0}];var NestedParse=function(){function e(e,t,r){this.from=e;this.parse=t;this.finish=r}return e}();var BlockContext=function(){function e(e,t,r,n){this.parser=e;this.input=t;this.parseContext=n;this.line=new Line;this.atEnd=false;this.nested=null;this.lineStart=r;this.block=CompositeBlock.create(Type.Document,0,this.lineStart,0,0);this.stack=[this.block];this.fragments=(n===null||n===void 0?void 0:n.fragments)?new FragmentCursor(n.fragments,t):null;this.updateLine(t.lineAfter(this.lineStart))}Object.defineProperty(e.prototype,"pos",{get:function(){return this.nested?this.nested.parse.pos:this.lineStart},enumerable:false,configurable:true});e.prototype.advance=function(){if(this.nested){var e=this.nested.parse.advance();if(e){var t=this.nested.finish(e);if(t instanceof Element)t=t.toTree(this.parser.nodeSet);this.addNode(t,this.nested.from);this.nested=null}return null}var r=this.line;for(;;){while(r.depth<this.stack.length)this.finishContext();for(var n=0,i=r.markers;n<i.length;n++){var s=i[n];this.addNode(s.type,s.from,s.to)}if(r.pos<r.text.length)break;if(!this.nextLine())return this.finish()}if(this.fragments&&this.reuseFragment(r.basePos))return null;e:for(;;){for(var a=0,o=this.parser.blockParsers;a<o.length;a++){var l=o[a];if(l){var f=l(this,r);if(f!=false){if(f==true)return null;r.forward();continue e}}}break}var p=new LeafBlock(this.lineStart+r.pos,r.text.slice(r.pos));for(var u=0,h=this.parser.leafBlockParsers;u<h.length;u++){var c=h[u];if(c){var d=c(this,p);if(d)p.parsers.push(d)}}e:while(this.nextLine()){if(r.pos==r.text.length)break;if(r.indent<r.baseIndent+4){for(var m=0,g=parser.endLeafBlock;m<g.length;m++){var k=g[m];if(k(this,r))break e}}for(var v=0,y=p.parsers;v<y.length;v++){var x=y[v];if(x.nextLine(this,r,p))return null}p.content+="\n"+r.scrub();for(var L=0,T=r.markers;L<T.length;L++){var S=T[L];p.marks.push(S)}}this.finishLeaf(p);return null};e.prototype.reuseFragment=function(e){if(!this.fragments.moveTo(this.lineStart+e,this.lineStart)||!this.fragments.matches(this.block.hash))return false;var t=this.fragments.takeNodes(this);if(!t)return false;this.lineStart+=t;if(this.lineStart<this.input.length){this.lineStart++;this.updateLine(this.input.lineAfter(this.lineStart))}else{this.atEnd=true;this.updateLine("")}return true};e.prototype.nextLine=function(){this.lineStart+=this.line.text.length;if(this.lineStart>=this.input.length){this.atEnd=true;this.updateLine("");return false}else{this.lineStart++;this.updateLine(this.input.lineAfter(this.lineStart));return true}};e.prototype.updateLine=function(e){var t=this.line;t.reset(e);for(;t.depth<this.stack.length;t.depth++){var r=this.stack[t.depth],n=this.parser.skipContextMarkup[r.type];if(!n)throw new Error("Unhandled block context "+Type[r.type]);if(!n(r,this,t))break;t.forward()}};e.prototype.prevLineEnd=function(){return this.atEnd?this.lineStart:this.lineStart-1};e.prototype.startContext=function(e,t,r){if(r===void 0){r=0}this.block=CompositeBlock.create(e,r,this.lineStart+t,this.block.hash,this.lineStart+this.line.text.length);this.stack.push(this.block)};e.prototype.startComposite=function(e,t,r){if(r===void 0){r=0}this.startContext(this.parser.getNodeType(e),t,r)};e.prototype.addNode=function(e,t,r){if(typeof e=="number")e=new Tree(this.parser.nodeSet.types[e],none,none,(r!==null&&r!==void 0?r:this.prevLineEnd())-t);this.block.children.push(e);this.block.positions.push(t-this.block.from)};e.prototype.addElement=function(e){this.block.children.push(e.toTree(this.parser.nodeSet));this.block.positions.push(e.from-this.block.from)};e.prototype.addLeafElement=function(e,t){this.addNode(this.buffer.writeElements(injectMarks(t.children,e.marks),-t.from).finish(t.type,t.to-t.from),t.from)};e.prototype.startNested=function(e,t,r){this.nested=new NestedParse(e,t,r)};e.prototype.finishContext=function(){this.block=finishContext(this.stack,this.parser.nodeSet)};e.prototype.finish=function(){while(this.stack.length>1)this.finishContext();return this.block.toTree(this.parser.nodeSet,this.lineStart)};e.prototype.forceFinish=function(){var e=this.stack.map((function(e){return e.copy()})),t=this.lineStart;if(this.nested){var r=e[e.length-1];var n=this.nested.finish(this.nested.parse.forceFinish());if(n instanceof Element)n=n.toTree(this.parser.nodeSet);var i=t-this.nested.from;if(n.length>i)n=new Tree(n.type,n.children.filter((function(e,t){return n.positions[t]<=i})),n.positions.filter((function(e){return e<=i})),i);r.children.push(n);r.positions.push(this.nested.from)}while(e.length>1)finishContext(e,this.parser.nodeSet);return e[0].toTree(this.parser.nodeSet,t)};e.prototype.finishLeaf=function(e){for(var t=0,r=e.parsers;t<r.length;t++){var n=r[t];if(n.finish(this,e))return}var i=injectMarks(this.parser.parseInline(e.content,e.start),e.marks);this.addNode(this.buffer.writeElements(i,-e.start).finish(Type.Paragraph,e.content.length),e.start)};e.prototype.elt=function(e,t,r,n){if(typeof e=="string")return elt(this.parser.getNodeType(e),t,r,n);return new TreeElement(e,t)};Object.defineProperty(e.prototype,"buffer",{get:function(){return new Buffer(this.parser.nodeSet)},enumerable:false,configurable:true});return e}();var MarkdownParser=function(){function e(e,t,r,n,i,s,a,o,l,f){this.nodeSet=e;this.codeParser=t;this.htmlParser=r;this.blockParsers=n;this.leafBlockParsers=i;this.blockNames=s;this.endLeafBlock=a;this.skipContextMarkup=o;this.inlineParsers=l;this.inlineNames=f;this.nodeTypes=Object.create(null);for(var p=0,u=e.types;p<u.length;p++){var h=u[p];this.nodeTypes[h.name]=h.id}}e.prototype.startParse=function(e,t,r){if(t===void 0){t=0}if(r===void 0){r={}}return new BlockContext(this,e,t,r)};e.prototype.configure=function(t){var r=resolveConfig(t);if(!r)return this;var n=this,i=n.nodeSet,s=n.skipContextMarkup;var a=this.blockParsers.slice(),o=this.leafBlockParsers.slice(),l=this.blockNames.slice(),f=this.inlineParsers.slice(),p=this.inlineNames.slice(),u=this.endLeafBlock.slice();if(nonEmpty(r.defineNodes)){s=Object.assign({},s);var h=i.types.slice();var c=function(e){var t=typeof e=="string"?{name:e}:e,r=t.name,n=t.block,i=t.composite;if(h.some((function(e){return e.name==r})))return"continue";if(i)s[h.length]=function(e,t,r){return i(t,r,e.value)};var a=h.length;var o=i?["Block","BlockContext"]:!n?undefined:a>=Type.ATXHeading1&&a<=Type.SetextHeading2?["Block","LeafBlock","Heading"]:["Block","LeafBlock"];h.push(NodeType.define({id:a,name:r,props:o&&[[NodeProp.group,o]]}))};for(var d=0,m=r.defineNodes;d<m.length;d++){var g=m[d];c(g)}i=new NodeSet(h)}if(nonEmpty(r.props))i=i.extend.apply(i,r.props);if(nonEmpty(r.remove)){for(var k=0,v=r.remove;k<v.length;k++){var y=v[k];var x=this.blockNames.indexOf(y),L=this.inlineNames.indexOf(y);if(x>-1)a[x]=o[x]=undefined;if(L>-1)f[L]=undefined}}if(nonEmpty(r.parseBlock)){for(var T=0,S=r.parseBlock;T<S.length;T++){var b=S[T];var C=l.indexOf(b.name);if(C>-1){a[C]=b.parse;o[C]=b.leaf}else{var w=b.before?findName(l,b.before):b.after?findName(l,b.after)+1:l.length-1;a.splice(w,0,b.parse);o.splice(w,0,b.leaf);l.splice(w,0,b.name)}if(b.endLeaf)u.push(b.endLeaf)}}if(nonEmpty(r.parseInline)){for(var E=0,B=r.parseInline;E<B.length;E++){var P=B[E];var C=p.indexOf(P.name);if(C>-1){f[C]=P.parse}else{var w=P.before?findName(p,P.before):P.after?findName(p,P.after)+1:p.length-1;f.splice(w,0,P.parse);p.splice(w,0,P.name)}}}return new e(i,r.codeParser||this.codeParser,r.htmlParser||this.htmlParser,a,o,l,u,s,f,p)};e.prototype.getNodeType=function(e){var t=this.nodeTypes[e];if(t==null)throw new RangeError("Unknown node type '"+e+"'");return t};e.prototype.parseInline=function(e,t){var r=new InlineContext(this,e,t);e:for(var n=t;n<r.end;){var i=r.char(n);for(var s=0,a=this.inlineParsers;s<a.length;s++){var o=a[s];if(o){var l=o(r,i,n);if(l>=0){n=l;continue e}}}n++}return r.resolveMarkers(0)};return e}();function nonEmpty(e){return e!=null&&e.length>0}function resolveConfig(e){if(!Array.isArray(e))return e;if(e.length==0)return null;var t=resolveConfig(e[0]);if(e.length==1)return t;var r=resolveConfig(e.slice(1));if(!r||!t)return t||r;var n=function(e,t){return(e||none).concat(t||none)};return{props:n(t.props,r.props),codeParser:r.codeParser||t.codeParser,htmlParser:r.htmlParser||t.htmlParser,defineNodes:n(t.defineNodes,r.defineNodes),parseBlock:n(t.parseBlock,r.parseBlock),parseInline:n(t.parseInline,r.parseInline),remove:n(t.remove,r.remove)}}function findName(e,t){var r=e.indexOf(t);if(r<0)throw new RangeError("Position specified relative to unknown parser "+t);return r}var nodeTypes=[NodeType.none];for(var i=1,name=void 0;name=Type[i];i++){nodeTypes[i]=NodeType.define({id:i,name:name,props:i>=Type.Escape?[]:[[NodeProp.group,i in DefaultSkipMarkup?["Block","BlockContext"]:["Block","LeafBlock"]]]})}function finishContext(e,t){var r=e.pop();var n=e[e.length-1];n.children.push(r.toTree(t));n.positions.push(r.from-n.from);return n}var none=[];var Buffer=function(){function e(e){this.nodeSet=e;this.content=[];this.nodes=[]}e.prototype.write=function(e,t,r,n){if(n===void 0){n=0}this.content.push(e,t,r,4+n*4);return this};e.prototype.writeElements=function(e,t){if(t===void 0){t=0}for(var r=0,n=e;r<n.length;r++){var i=n[r];i.writeTo(this,t)}return this};e.prototype.finish=function(e,t){return Tree.build({buffer:this.content,nodeSet:this.nodeSet,reused:this.nodes,topID:e,length:t})};return e}();var Element=function(){function e(e,t,r,n){if(n===void 0){n=none}this.type=e;this.from=t;this.to=r;this.children=n}e.prototype.writeTo=function(e,t){var r=e.content.length;e.writeElements(this.children,t);e.content.push(this.type,this.from+t,this.to+t,e.content.length+4-r)};e.prototype.toTree=function(e){return new Buffer(e).writeElements(this.children,-this.from).finish(this.type,this.to-this.from)};return e}();var TreeElement=function(){function e(e,t){this.tree=e;this.from=t}Object.defineProperty(e.prototype,"to",{get:function(){return this.from+this.tree.length},enumerable:false,configurable:true});Object.defineProperty(e.prototype,"type",{get:function(){return this.tree.type.id},enumerable:false,configurable:true});Object.defineProperty(e.prototype,"children",{get:function(){return none},enumerable:false,configurable:true});e.prototype.writeTo=function(e,t){e.nodes.push(this.tree);e.content.push(e.nodes.length-1,this.from+t,this.to+t,-1)};e.prototype.toTree=function(){return this.tree};return e}();function elt(e,t,r,n){return new Element(e,t,r,n)}var EmphasisUnderscore={resolve:"Emphasis",mark:"EmphasisMark"};var EmphasisAsterisk={resolve:"Emphasis",mark:"EmphasisMark"};var LinkStart={},ImageStart={};var InlineDelimiter=function(){function e(e,t,r,n){this.type=e;this.from=t;this.to=r;this.side=n}return e}();var Escapable="!\"#$%&'()*+,-./:;<=>?@[\\]^_`{|}~";var Punctuation=/[!"#$%&'()*+,\-.\/:;<=>?@\[\\\]^_`{|}~\xA1\u2010-\u2027]/;try{Punctuation=/[\p{Pc}|\p{Pd}|\p{Pe}|\p{Pf}|\p{Pi}|\p{Po}|\p{Ps}]/u}catch(_){}var DefaultInline={Escape:function(e,t,r){if(t!=92||r==e.end-1)return-1;var n=e.char(r+1);for(var i=0;i<Escapable.length;i++)if(Escapable.charCodeAt(i)==n)return e.append(elt(Type.Escape,r,r+2));return-1},Entity:function(e,t,r){if(t!=38)return-1;var n=/^(?:#\d+|#x[a-f\d]+|\w+);/i.exec(e.slice(r+1,r+31));return n?e.append(elt(Type.Entity,r,r+1+n[0].length)):-1},InlineCode:function(e,t,r){if(t!=96||r&&e.char(r-1)==96)return-1;var n=r+1;while(n<e.end&&e.char(n)==96)n++;var i=n-r,s=0;for(;n<e.end;n++){if(e.char(n)==96){s++;if(s==i&&e.char(n+1)!=96)return e.append(elt(Type.InlineCode,r,n+1,[elt(Type.CodeMark,r,r+i),elt(Type.CodeMark,n+1-i,n+1)]))}else{s=0}}return-1},HTMLTag:function(e,t,r){if(t!=60||r==e.end-1)return-1;var n=e.slice(r+1,e.end);var i=/^(?:[a-z][-\w+.]+:[^\s>]+|[a-z\d.!#$%&'*+/=?^_`{|}~-]+@[a-z\d](?:[a-z\d-]{0,61}[a-z\d])?(?:\.[a-z\d](?:[a-z\d-]{0,61}[a-z\d])?)*)>/i.exec(n);if(i)return e.append(elt(Type.URL,r,r+1+i[0].length));var s=/^!--[^>](?:-[^-]|[^-])*?-->/i.exec(n);if(s)return e.append(elt(Type.Comment,r,r+1+s[0].length));var a=/^\?[^]*?\?>/.exec(n);if(a)return e.append(elt(Type.ProcessingInstruction,r,r+1+a[0].length));var o=/^(?:![A-Z][^]*?>|!\[CDATA\[[^]*?\]\]>|\/\s*[a-zA-Z][\w-]*\s*>|\s*[a-zA-Z][\w-]*(\s+[a-zA-Z:_][\w-.:]*(?:\s*=\s*(?:[^\s"'=<>`]+|'[^']*'|"[^"]*"))?)*\s*(\/\s*)?>)/.exec(n);if(!o)return-1;var l=[];if(e.parser.htmlParser){var f=e.parser.htmlParser.startParse(stringInput(e.slice(r,r+1+o[0].length)),0,{}),p;while(!(p=f.advance())){}l=p.children.map((function(e,t){return new TreeElement(e,r+p.positions[t])}))}return e.append(elt(Type.HTMLTag,r,r+1+o[0].length,l))},Emphasis:function(e,t,r){if(t!=95&&t!=42)return-1;var n=r+1;while(e.char(n)==t)n++;var i=e.slice(r-1,r),s=e.slice(n,n+1);var a=Punctuation.test(i),o=Punctuation.test(s);var l=/\s|^$/.test(i),f=/\s|^$/.test(s);var p=!f&&(!o||l||a);var u=!l&&(!a||f||o);var h=p&&(t==42||!u||a);var c=u&&(t==42||!p||o);return e.append(new InlineDelimiter(t==95?EmphasisUnderscore:EmphasisAsterisk,r,n,(h?1:0)|(c?2:0)))},HardBreak:function(e,t,r){if(t==92&&e.char(r+1)==10)return e.append(elt(Type.HardBreak,r,r+2));if(t==32){var n=r+1;while(e.char(n)==32)n++;if(e.char(n)==10&&n>=r+2)return e.append(elt(Type.HardBreak,r,n+1))}return-1},Link:function(e,t,r){return t==91?e.append(new InlineDelimiter(LinkStart,r,r+1,1)):-1},Image:function(e,t,r){return t==33&&e.char(r+1)==91?e.append(new InlineDelimiter(ImageStart,r,r+2,1)):-1},LinkEnd:function(e,t,r){if(t!=93)return-1;for(var n=e.parts.length-1;n>=0;n--){var i=e.parts[n];if(i instanceof InlineDelimiter&&(i.type==LinkStart||i.type==ImageStart)){if(!i.side||e.skipSpace(i.to)==r&&!/[(\[]/.test(e.slice(r+1,r+2))){e.parts[n]=null;return-1}var s=e.takeContent(n);var a=e.parts[n]=finishLink(e,s,i.type==LinkStart?Type.Link:Type.Image,i.from,r+1);if(i.type==LinkStart)for(var o=0;o<n;o++){var l=e.parts[o];if(l instanceof InlineDelimiter&&l.type==LinkStart)l.side=0}return a.to}}return-1}};function finishLink(e,t,r,n,i){var s=e.text,a=e.char(i),o=i;t.unshift(elt(Type.LinkMark,n,n+(r==Type.Image?2:1)));t.push(elt(Type.LinkMark,i-1,i));if(a==40){var l=e.skipSpace(i+1);var f=parseURL(s,l-e.offset,e.offset),p=void 0;if(f){l=e.skipSpace(f.to);p=parseLinkTitle(s,l-e.offset,e.offset);if(p)l=e.skipSpace(p.to)}if(e.char(l)==41){t.push(elt(Type.LinkMark,i,i+1));o=l+1;if(f)t.push(f);if(p)t.push(p);t.push(elt(Type.LinkMark,l,o))}}else if(a==91){var u=parseLinkLabel(s,i-e.offset,e.offset,false);if(u){t.push(u);o=u.to}}return elt(r,n,o,t)}function parseURL(e,t,r){var n=e.charCodeAt(t);if(n==60){for(var i=t+1;i<e.length;i++){var s=e.charCodeAt(i);if(s==62)return elt(Type.URL,t+r,i+1+r);if(s==60||s==10)return false}return null}else{var a=0,i=t;for(var o=false;i<e.length;i++){var s=e.charCodeAt(i);if(space(s)){break}else if(o){o=false}else if(s==40){a++}else if(s==41){if(!a)break;a--}else if(s==92){o=true}}return i>t?elt(Type.URL,t+r,i+r):i==e.length?null:false}}function parseLinkTitle(e,t,r){var n=e.charCodeAt(t);if(n!=39&&n!=34&&n!=40)return false;var i=n==40?41:n;for(var s=t+1,a=false;s<e.length;s++){var o=e.charCodeAt(s);if(a)a=false;else if(o==i)return elt(Type.LinkTitle,t+r,s+1+r);else if(o==92)a=true}return null}function parseLinkLabel(e,t,r,n){for(var i=false,s=t+1,a=Math.min(e.length,s+999);s<a;s++){var o=e.charCodeAt(s);if(i)i=false;else if(o==93)return n?false:elt(Type.LinkLabel,t+r,s+1+r);else{if(n&&!space(o))n=false;if(o==91)return false;else if(o==92)i=true}}return null}var InlineContext=function(){function e(e,t,r){this.parser=e;this.text=t;this.offset=r;this.parts=[]}e.prototype.char=function(e){return e>=this.end?-1:this.text.charCodeAt(e-this.offset)};Object.defineProperty(e.prototype,"end",{get:function(){return this.offset+this.text.length},enumerable:false,configurable:true});e.prototype.slice=function(e,t){return this.text.slice(e-this.offset,t-this.offset)};e.prototype.append=function(e){this.parts.push(e);return e.to};e.prototype.addDelimiter=function(e,t,r,n,i){return this.append(new InlineDelimiter(e,t,r,(n?1:0)|(i?2:0)))};e.prototype.addElement=function(e){return this.append(e)};e.prototype.resolveMarkers=function(e){for(var t=e;t<this.parts.length;t++){var r=this.parts[t];if(!(r instanceof InlineDelimiter&&r.type.resolve&&r.side&2))continue;var n=r.type==EmphasisUnderscore||r.type==EmphasisAsterisk;var i=r.to-r.from;var s=void 0,a=t-1;for(;a>=e;a--){var o=this.parts[a];if(!(o instanceof InlineDelimiter&&o.side&1&&o.type==r.type)||n&&(r.side&1||o.side&2)&&(o.to-o.from+i)%3==0&&((o.to-o.from)%3||i%3))continue;s=o;break}if(!s)continue;var l=r.type.resolve,f=[];var p=s.from,u=r.to;if(n){var h=Math.min(2,s.to-s.from,i);p=s.to-h;u=r.from+h;l=h==1?"Emphasis":"StrongEmphasis"}if(s.type.mark)f.push(this.elt(s.type.mark,p,s.to));for(var c=a+1;c<t;c++){if(this.parts[c]instanceof Element)f.push(this.parts[c]);this.parts[c]=null}if(r.type.mark)f.push(this.elt(r.type.mark,r.from,u));var d=this.elt(l,p,u,f);this.parts[a]=n&&s.from!=p?new InlineDelimiter(s.type,s.from,p,s.side):null;var m=this.parts[t]=n&&r.to!=u?new InlineDelimiter(r.type,u,r.to,r.side):null;if(m)this.parts.splice(t,0,d);else this.parts[t]=d}var g=[];for(var t=e;t<this.parts.length;t++){var o=this.parts[t];if(o instanceof Element)g.push(o)}return g};e.prototype.findOpeningDelimiter=function(e){for(var t=this.parts.length-1;t>=0;t--){var r=this.parts[t];if(r instanceof InlineDelimiter&&r.type==e)return t}return null};e.prototype.takeContent=function(e){var t=this.resolveMarkers(e);this.parts.length=e;return t};e.prototype.skipSpace=function(e){return skipSpace(this.text,e-this.offset)+this.offset};e.prototype.elt=function(e,t,r,n){if(typeof e=="string")return elt(this.parser.getNodeType(e),t,r,n);return new TreeElement(e,t)};return e}();function injectMarks(e,t){if(!t.length)return e;if(!e.length)return t;var r=e.slice(),n=0;for(var i=0,s=t;i<s.length;i++){var a=s[i];while(n<r.length&&r[n].to<a.to)n++;if(n<r.length&&r[n].from<a.from){var o=r[n];if(o instanceof Element)r[n]=new Element(o.type,o.from,o.to,injectMarks(o.children,[a]))}else{r.splice(n++,0,a)}}return r}var ContextHash=new WeakMap;function stampContext(e,t){for(var r=0,n=e;r<n.length;r++){var i=n[r];ContextHash.set(i,t);if(i instanceof Tree&&i.type.isAnonymous)stampContext(i.children,t)}}var NotLast=[Type.CodeBlock,Type.ListItem,Type.OrderedList,Type.BulletList];var FragmentCursor=function(){function e(e,t){this.fragments=e;this.input=t;this.i=0;this.fragment=null;this.fragmentEnd=-1;this.cursor=null;if(e.length)this.fragment=e[this.i++]}e.prototype.nextFragment=function(){this.fragment=this.i<this.fragments.length?this.fragments[this.i++]:null;this.cursor=null;this.fragmentEnd=-1};e.prototype.moveTo=function(e,t){while(this.fragment&&this.fragment.to<=e)this.nextFragment();if(!this.fragment||this.fragment.from>(e?e-1:0))return false;if(this.fragmentEnd<0){var r=this.fragment.to;while(r>0&&this.input.get(r-1)!=10)r--;this.fragmentEnd=r?r-1:0}var n=this.cursor;if(!n){n=this.cursor=this.fragment.tree.cursor();n.firstChild()}var i=e+this.fragment.offset;while(n.to<=i)if(!n.parent())return false;for(;;){if(n.from>=i)return this.fragment.from<=t;if(!n.childAfter(i))return false}};e.prototype.matches=function(e){var t=this.cursor.tree;return t&&ContextHash.get(t)==e};e.prototype.takeNodes=function(e){var t=this.cursor,r=this.fragment.offset;var n=e.lineStart,i=n,s=e.block.children.length;var a=i,o=s;for(;;){if(t.to-r>=this.fragmentEnd){if(t.type.isAnonymous&&t.firstChild())continue;break}e.addNode(t.tree,t.from-r);if(t.type.is("Block")){if(NotLast.indexOf(t.type.id)<0){i=t.to-r;s=e.block.children.length}else{i=a;s=o;a=t.to-r;o=e.block.children.length}}if(!t.nextSibling())break}while(e.block.children.length>s){e.block.children.pop();e.block.positions.pop()}return i-n};return e}();var parser=new MarkdownParser(new NodeSet(nodeTypes),null,null,Object.keys(DefaultBlockParsers).map((function(e){return DefaultBlockParsers[e]})),Object.keys(DefaultBlockParsers).map((function(e){return DefaultLeafBlocks[e]})),Object.keys(DefaultBlockParsers),DefaultEndLeaf,DefaultSkipMarkup,Object.keys(DefaultInline).map((function(e){return DefaultInline[e]})),Object.keys(DefaultInline));var StrikethroughDelim={resolve:"Strikethrough",mark:"StrikethroughMark"};var Strikethrough={defineNodes:["Strikethrough","StrikethroughMark"],parseInline:[{name:"Strikethrough",parse:function(e,t,r){if(t!=126||e.char(r+1)!=126)return-1;return e.addDelimiter(StrikethroughDelim,r,r+2,true,true)},after:"Emphasis"}]};function parseRow(e,t,r,n,i){if(r===void 0){r=0}if(i===void 0){i=0}var s=0,a=true,o=-1,l=-1,f=false;var p=function(){n.push(e.elt("TableCell",i+o,i+l,e.parser.parseInline(t.slice(o,l),i+o)))};for(var u=r;u<t.length;u++){var h=t.charCodeAt(u);if(h==124&&!f){if(!a||o>-1)s++;a=false;if(n){if(o>-1)p();n.push(e.elt("TableDelimiter",u+i,u+i+1))}o=l=-1}else if(f||h!=32&&h!=9){if(o<0)o=u;l=u+1}f=!f&&h==92}if(o>-1){s++;if(n)p()}return s}function hasPipe(e,t){for(var r=t;r<e.length;r++){var n=e.charCodeAt(r);if(n==124)return true;if(n==92)r++}return false}var TableParser=function(){function e(){this.rows=null}e.prototype.nextLine=function(e,t,r){if(this.rows==null){this.rows=false;var n=void 0;if((t.next==45||t.next==58||t.next==124)&&/^\|?(\s*:?-+:?\s*\|)+(\s*:?-+:?\s*)?$/.test(n=t.text.slice(t.pos))){var i=[],s=parseRow(e,r.content,0,i,r.start);if(s==parseRow(e,n,t.pos))this.rows=[e.elt("TableHeader",r.start,r.start+r.content.length,i),e.elt("TableDelimiter",e.lineStart+t.pos,e.lineStart+t.text.length)]}}else if(this.rows){var a=[];parseRow(e,t.text,t.pos,a,e.lineStart);this.rows.push(e.elt("TableRow",e.lineStart+t.pos,e.lineStart+t.text.length,a))}return false};e.prototype.finish=function(e,t){if(this.rows){this.emit(e,t);return true}return false};e.prototype.emit=function(e,t){e.addLeafElement(t,e.elt("Table",t.start,t.start+t.content.length,this.rows))};return e}();var Table={defineNodes:[{name:"Table",block:true},"TableHeader","TableRow","TableCell","TableDelimiter"],parseBlock:[{name:"Table",leaf:function(e,t){return hasPipe(t.content,0)?new TableParser:null},before:"SetextHeading"}]};var TaskParser=function(){function e(){}e.prototype.nextLine=function(){return false};e.prototype.finish=function(e,t){e.addLeafElement(t,e.elt("Task",t.start,t.start+t.content.length,__spreadArray([e.elt("TaskMarker",t.start,t.start+3)],e.parser.parseInline(t.content.slice(3),t.start+3))));return true};return e}();var TaskList={defineNodes:[{name:"Task",block:true},"TaskMarker"],parseBlock:[{name:"TaskList",leaf:function(e,t){return/^\[[ xX]\]/.test(t.content)&&e.parser.nodeSet.types[e.block.type].name=="ListItem"?new TaskParser:null},after:"SetextHeading"}]};var GFM=[Table,TaskList,Strikethrough];function parseSubSuper(e,t,r){return function(n,i,s){if(i!=e||n.char(s+1)==e)return-1;var a=[n.elt(r,s,s+1)];for(var o=s+1;o<n.end;o++){var l=n.char(o);if(l==e)return n.addElement(n.elt(t,s,o+1,a.concat(n.elt(r,o,o+1))));if(l==92)a.push(n.elt("Escape",o,o+++2));if(space(l))break}return-1}}var Superscript={defineNodes:["Superscript","SuperscriptMark"],parseInline:[{name:"Superscript",parse:parseSubSuper(94,"Superscript","SuperscriptMark")}]};var Subscript={defineNodes:["Subscript","SubscriptMark"],parseInline:[{name:"Subscript",parse:parseSubSuper(126,"Subscript","SubscriptMark")}]};var Emoji={defineNodes:["Emoji"],parseInline:[{name:"Emoji",parse:function(e,t,r){var n;if(t!=58||!(n=/^[a-zA-Z_0-9]+:/.exec(e.slice(r+1,e.end))))return-1;return e.addElement(e.elt("Emoji",r,r+1+n[0].length))}}]};var data=defineLanguageFacet({block:{open:"\x3c!--",close:"--\x3e"}});var commonmark=parser.configure({props:[styleTags({"Blockquote/...":tags.quote,HorizontalRule:tags.contentSeparator,"ATXHeading1/... SetextHeading1/...":tags.heading1,"ATXHeading2/... SetextHeading2/...":tags.heading2,"ATXHeading3/...":tags.heading3,"ATXHeading4/...":tags.heading4,"ATXHeading5/...":tags.heading5,"ATXHeading6/...":tags.heading6,"Comment CommentBlock":tags.comment,Escape:tags.escape,Entity:tags.character,"Emphasis/...":tags.emphasis,"StrongEmphasis/...":tags.strong,"Link/... Image/...":tags.link,"OrderedList/... BulletList/...":tags.list,"BlockQuote/...":tags.quote,"InlineCode/... CodeBlock FencedCode":tags.monospace,URL:tags.url,"HeaderMark HardBreak QuoteMark ListMark LinkMark EmphasisMark CodeMark":tags.processingInstruction,"CodeInfo LinkLabel":tags.labelName,LinkTitle:tags.string,Paragraph:tags.content}),foldNodeProp.add((function(e){if(!e.is("Block")||e.is("Document"))return undefined;return function(e,t){return{from:t.doc.lineAt(e.from).to,to:e.to}}})),indentNodeProp.add({Document:function(){return null}}),languageDataProp.add({Document:data})],htmlParser:htmlLanguage.parser.configure({dialect:"noMatch"})});var commonmarkLanguage=mkLang(commonmark);var extended=commonmark.configure([GFM,Subscript,Superscript,Emoji,{props:[styleTags({"TableDelimiter SubscriptMark SuperscriptMark StrikethroughMark":tags.processingInstruction,"TableHeader/...":tags.heading,"Strikethrough/...":tags.strikethrough,TaskMarker:tags.atom,Task:tags.list,Emoji:tags.character,"Subscript Superscript":tags.special(tags.content),TableCell:tags.content})]}]);var markdownLanguage=mkLang(extended);function mkLang(e){return new Language(data,e,e.nodeSet.types.find((function(e){return e.name=="Document"})))}function addCodeLanguages(e,t){return{codeParser:function(r){var n=r&&LanguageDescription.matchLanguageName(e,r,true);if(!n)return t?t.parser:null;if(n.support)return n.support.language.parser;return EditorParseContext.getSkippingParser(n.load())}}}function nodeStart(e,t){return t.sliceString(e.from,e.from+50)}function gatherMarkup(e,t,r){var n=[];for(var i=e;i&&i.name!="Document";i=i.parent){if(i.name=="ListItem"||i.name=="Blockquote")n.push(i)}var s=[],a=0;for(var o=n.length-1;o>=0;o--){var l=n[o],f=void 0;if(l.name=="Blockquote"&&(f=/^\s*> ?/.exec(t.slice(a)))){s.push({from:a,string:f[0],node:l});a+=f[0].length}else if(l.name=="ListItem"&&l.parent.name=="OrderedList"&&(f=/^\s*\d+([.)])\s*/.exec(nodeStart(l,r)))){var p=f[1].length>=4?f[0].length-f[1].length+1:f[0].length;s.push({from:a,string:t.slice(a,a+p).replace(/\S/g," "),node:l});a+=p}else if(l.name=="ListItem"&&l.parent.name=="BulletList"&&(f=/^\s*[-+*] (\s*)/.exec(nodeStart(l,r)))){var p=f[1].length>=4?f[0].length-f[1].length:f[0].length;s.push({from:a,string:t.slice(a,a+p).replace(/\S/g," "),node:l});a+=p}}return s}function renumberList(e,t,r){for(var n=-1,i=e;;){if(i.name=="ListItem"){var s=/^(\s*)(\d+)(?=[.)])/.exec(t.sliceString(i.from,i.from+10));if(!s)return;var a=+s[2];if(n>=0){if(a!=n+1)return;r.push({from:i.from+s[1].length,to:i.from+s[0].length,insert:String(n+2)})}n=a}var o=i.nextSibling;if(!o)break;i=o}}var insertNewlineContinueMarkup=function(e){var t=e.state,r=e.dispatch;var n=syntaxTree(t);var i=null,s=t.changeByRange((function(e){if(e.empty&&markdownLanguage.isActiveAt(t,e.from)){var r=t.doc.lineAt(e.from);var s=gatherMarkup(n.resolve(e.from,-1),r.text,t.doc);var a=e.from,o=[];if(s.length){var l=s[s.length-1],f=l.from+l.string.length;var p=e.from-r.from>=f&&!/\S/.test(r.text.slice(f,e.from-r.from));if(p){var u=/List/.test(l.node.name)?l.from:f;while(u>0&&/\s/.test(r.text[u-1]))u--;a=r.from+u}if(l.node.name=="ListItem"){if(p&&r.from>0&&!/[^\s>]/.test(t.doc.lineAt(r.from-1).text))return{range:EditorSelection.cursor(a),changes:{from:a,to:e.from}};if(a<e.from&&l.node.parent.from==l.node.from){l.string=""}else{if(l.node.from>=r.from)l.string=r.text.slice(l.from,l.from+l.string.length);else l.string=/^\s*/.exec(r.text)[0].slice(0,l.string.length);if(l.node.parent.name=="OrderedList"&&a==e.from){l.string=l.string.replace(/\d+/,(function(e){return+e+1}));renumberList(l.node,t.doc,o)}}}}var h=s.map((function(e){return e.string})).join("");if(e.from-r.from<h.length)h="";o.push({from:a,to:e.from,insert:Text.of(["",h])});return{range:EditorSelection.cursor(a+1+h.length),changes:o}}return i={range:e}}));if(i)return false;r(t.update(s,{scrollIntoView:true}));return true};var deleteMarkupBackward=function(e){var t=e.state,r=e.dispatch;var n=syntaxTree(t);var i=null,s=t.changeByRange((function(e){if(e.empty&&markdownLanguage.isActiveAt(t,e.from)){var r=t.doc.lineAt(e.from);var s=gatherMarkup(n.resolve(e.from,-1),r.text,t.doc);if(s.length){var a=s[s.length-1],o=a.from+a.string.length;if(e.from>o+r.from&&!/\S/.test(r.text.slice(o,e.from-r.from)))return{range:EditorSelection.cursor(o+r.from),changes:{from:o+r.from,to:e.from}};if(e.from-r.from==o){var l=r.from+a.from;if(a.node.name=="ListItem"&&a.node.parent.from<a.node.from&&/\S/.test(r.text.slice(a.from,o)))return{range:e,changes:{from:l,to:l+a.string.length,insert:a.string}};if(l<e.from)return{range:EditorSelection.cursor(l),changes:{from:l,to:e.from}}}}}return i={range:e}}));if(i)return false;r(t.update(s,{scrollIntoView:true}));return true};var markdownKeymap=[{key:"Enter",run:insertNewlineContinueMarkup},{key:"Backspace",run:deleteMarkupBackward}];function markdown(e){if(e===void 0){e={}}var t=e.codeLanguages,r=e.defaultCodeLanguage,n=e.addKeymap,i=n===void 0?true:n,s=e.base,a=s===void 0?commonmarkLanguage:s,o=a.parser;var l=e.extensions?[e.extensions]:[];if(!(o instanceof MarkdownParser))throw new RangeError("Base parser provided to `markdown` should be a Markdown parser");if(t||r)l.push(addCodeLanguages(t||[],r));return new LanguageSupport(mkLang(o.configure(l)),i?Prec.extend(keymap.of(markdownKeymap)):[])}export{commonmarkLanguage,deleteMarkupBackward,insertNewlineContinueMarkup,markdown,markdownKeymap,markdownLanguage};